- name: Deploy Application Services
  hosts: all
  remote_user: "{{ target_user }}"
  become: yes

  tasks:
    - name: Flush handlers to ensure Nomad is restarted with new config
      ansible.builtin.meta: flush_handlers

    - name: Wait for a Consul leader to be elected
      ansible.builtin.uri:
        url: "http://127.0.0.1:8500/v1/status/leader"
        return_content: yes
      register: consul_leader_status
      until: consul_leader_status.content != '""' and consul_leader_status.status == 200
      retries: 12
      delay: 5
      ignore_errors: yes

    - name: Fail gracefully if no Consul leader is found
      ansible.builtin.fail:
        msg: |
          The Consul service is running, but it has not elected a leader after 60 seconds.
          This usually means the `bootstrap_expect` value in your Consul configuration is
          higher than the number of server nodes available.
      when: consul_leader_status.skipped is not defined and (consul_leader_status.failed or consul_leader_status.content == '""')

    - name: Install system dependencies
      ansible.builtin.include_role:
        name: system_deps

    - name: Install all python dependencies
      ansible.builtin.include_role:
        name: python_deps

    - name: Run pre-Home Assistant application roles
      ansible.builtin.include_role:
        name: "{{ role_name }}"
      loop:
        - mqtt
      loop_control:
        loop_var: role_name

    - name: Deploy Home Assistant with error handling
      block:
        - name: Run home_assistant role
          ansible.builtin.include_role:
            name: home_assistant
      rescue:
        - name: On failure, run Home Assistant diagnostic playbook
          ansible.builtin.import_playbook: "{{ playbook_dir }}/../../diagnose_and_log_home_assistant.yaml"
        - name: Fail the playbook after diagnostics
          ansible.builtin.fail:
            msg: "Home Assistant deployment failed. Diagnostic log has been created."

    - name: Run post-Home Assistant application roles
      ansible.builtin.include_role:
        name: "{{ role_name }}"
      loop:
        - provisioning_api
        - desktop_extras
        - paddler
        - vision
        - power_manager
        - world_model_service
        - tool_server
        - llxprt_code
        - claude_clone
      loop_control:
        loop_var: role_name
