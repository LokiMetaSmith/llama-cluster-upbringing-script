- name: Deploy Application Services
  hosts: all
  remote_user: "{{ target_user }}"
  become: yes

  tags:
    - app-services

  tasks:
    - name: Flush handlers to ensure Nomad is restarted with new config
      ansible.builtin.meta: flush_handlers
      tags:
        - always

    - name: Wait for a Consul leader to be elected
      ansible.builtin.uri:
        url: "http://127.0.0.1:8500/v1/status/leader"
        return_content: yes
      register: consul_leader_status
      until: consul_leader_status.content != '""' and consul_leader_status.status == 200
      retries: 12
      delay: 5
      ignore_errors: yes
      tags:
        - consul

    - name: Fail gracefully if no Consul leader is found
      ansible.builtin.fail:
        msg: |
          The Consul service is running, but it has not elected a leader after 60 seconds.
          This usually means the `bootstrap_expect` value in your Consul configuration is
          higher than the number of server nodes available.
      when: consul_leader_status.skipped is not defined and (consul_leader_status.failed or consul_leader_status.content == '""')
      tags:
        - consul

    - name: Install system dependencies
      ansible.builtin.include_role:
        name: system_deps
      tags:
        - system_deps

    - name: Install all python dependencies
      ansible.builtin.include_role:
        name: python_deps
      tags:
        - python_deps
        - deploy_app

    - name: Run pre-Home Assistant application roles
      ansible.builtin.include_role:
        name: "{{ role_name }}"
      loop:
        - mqtt
      loop_control:
        loop_var: role_name
      tags:
        - mqtt

    - name: Deploy Home Assistant with error handling
      tags:
        - home_assistant
      block:
        - name: Run home_assistant role
          ansible.builtin.include_role:
            name: home_assistant
      rescue:
        - name: On failure, run Home Assistant diagnostic tasks
          ansible.builtin.include_tasks:
            file: tasks/diagnose_home_assistant.yaml
          vars:
            log_file: "{{ playbook_dir }}/home_assistant_debug.log"
        - name: Fail the playbook after diagnostics
          ansible.builtin.fail:
            msg: "Home Assistant deployment failed. Diagnostic log has been created at {{ playbook_dir }}/home_assistant_debug.log"
      when: enable_home_assistant | default(true)

    - name: Run Provisioning API
      ansible.builtin.include_role:
        name: provisioning_api
      when: enable_provisioning_api | default(true)
      tags:
        - provisioning_api

    - name: Run post-Home Assistant application roles
      ansible.builtin.include_role:
        name: "{{ role_name }}"
      loop:
        - desktop_extras
        - vision
        - power_manager
        - world_model_service
        - term_everything
        - tool_server
        - llxprt_code
        - claude_clone
        - moe_gateway
        - mcp_server
      loop_control:
        loop_var: role_name
      tags:
        - provisioning_api
        - desktop_extras
        - vision
        - power_manager
        - world_model_service
        - tool_server

    - name: Run Paddler Stack
      when: enable_paddler | default(false)
      tags:
        - paddler
      block:
        - name: Install Paddler Binary
          ansible.builtin.include_role:
            name: paddler

        - name: Configure Paddler Balancer
          ansible.builtin.include_role:
            name: paddler_balancer
          when: inventory_hostname == (paddler_balancer_host | default('controller_node'))

        - name: Configure Paddler Agent
          ansible.builtin.include_role:
            name: paddler_agent
