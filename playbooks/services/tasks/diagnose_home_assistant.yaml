- name: Start logging session
  ansible.builtin.lineinfile:
    create: yes
    path: "{{ log_file }}"
    line: "--- Diagnostic run for Home Assistant at {{ ansible_facts['date_time']['iso8601'] }} ---"
    mode: '0644'

- name: Check Nomad job status for MQTT
  ansible.builtin.command: "nomad job status mqtt"
  register: mqtt_job_status
  changed_when: false
  ignore_errors: yes

- name: Log MQTT job status
  ansible.builtin.lineinfile:
    path: "{{ log_file }}"
    line: |
      [MQTT JOB STATUS]
      RC: {{ mqtt_job_status.rc }}
      STDOUT:
      {{ mqtt_job_status.stdout | indent(2) }}
      STDERR:
      {{ mqtt_job_status.stderr | indent(2) }}

- name: Get latest MQTT allocation ID
  ansible.builtin.shell:
    cmd: |
      set -o pipefail
      nomad job status -json mqtt | jq -r '.Allocations[0].ID'
    executable: /bin/bash
  register: mqtt_alloc_id
  changed_when: false
  when: mqtt_job_status.rc == 0

- name: Get MQTT allocation logs
  ansible.builtin.command: "nomad alloc logs {{ mqtt_alloc_id.stdout }}"
  register: mqtt_alloc_logs
  changed_when: false
  when: mqtt_alloc_id.stdout is defined and mqtt_alloc_id.stdout != ""

- name: Log MQTT allocation logs
  ansible.builtin.lineinfile:
    path: "{{ log_file }}"
    line: |
      [MQTT ALLOCATION LOGS]
      {{ mqtt_alloc_logs.stdout | indent(2) }}
  when: mqtt_alloc_logs.stdout is defined

- name: Check Nomad job status
  ansible.builtin.command: "nomad job status home-assistant"
  register: job_status
  changed_when: false
  ignore_errors: yes

- name: Log job status
  ansible.builtin.lineinfile:
    path: "{{ log_file }}"
    line: |
      [JOB STATUS]
      RC: {{ job_status.rc }}
      STDOUT:
      {{ job_status.stdout | indent(2) }}
      STDERR:
      {{ job_status.stderr | indent(2) }}

- name: Get latest allocation ID
  ansible.builtin.shell:
    cmd: |
      set -o pipefail
      nomad job status -t "{{ '{{' }} .ID {{ '}}' }}" home-assistant | head -n 1
    executable: /bin/bash
  register: alloc_id
  changed_when: false
  when: job_status.rc == 0

- name: Get allocation details
  ansible.builtin.command: "nomad alloc status {{ alloc_id.stdout }}"
  register: alloc_status
  changed_when: false
  when: alloc_id.stdout is defined and alloc_id.stdout != ""

- name: Log allocation status
  ansible.builtin.lineinfile:
    path: "{{ log_file }}"
    line: |
      [ALLOCATION STATUS]
      {{ alloc_status.stdout | indent(2) }}
  when: alloc_status.stdout is defined

- name: Get allocation logs
  ansible.builtin.command: "nomad alloc logs {{ alloc_id.stdout }}"
  register: alloc_logs
  changed_when: false
  when: alloc_id.stdout is defined and alloc_id.stdout != ""

- name: Log allocation logs
  ansible.builtin.lineinfile:
    path: "{{ log_file }}"
    line: |
      [ALLOCATION LOGS]
      {{ alloc_logs.stdout | indent(2) }}
  when: alloc_logs.stdout is defined

- name: Check host volume permissions
  ansible.builtin.stat:
    path: /opt/nomad/volumes/ha-config
  register: ha_config_stat
  become: yes

- name: Log host volume permissions
  ansible.builtin.lineinfile:
    path: "{{ log_file }}"
    line: |
      [HOST VOLUME PERMISSIONS]
      Path: {{ ha_config_stat.stat.path }}
      Owner: {{ ha_config_stat.stat.pw_name | default('unknown') }} ({{ ha_config_stat.stat.uid }})
      Group: {{ ha_config_stat.stat.gr_name | default('unknown') }} ({{ ha_config_stat.stat.gid }})
      Mode: {{ ha_config_stat.stat.mode }}

- name: Display final log location
  ansible.builtin.debug:
    msg: "Home Assistant diagnostic log created at: {{ log_file }}"
