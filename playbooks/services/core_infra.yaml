- hosts: all
  remote_user: "{{ target_user }}"
  become: yes

  tags:
    - core-infra

  pre_tasks:
    - name: Ensure rsync is installed for synchronization tasks
      tags:
        - rsync
      ansible.builtin.apt:
        name: rsync
        state: present
        update_cache: yes

    - name: Check connectivity to all nodes
      tags:
        - ping
      ansible.builtin.ping:

    - name: Distribute control repository to all nodes
      tags:
        - sync
      ansible.posix.synchronize:
        src: "{{ playbook_dir }}/../../"
        dest: /opt/cluster-infra/
        rsync_opts:
          - "--exclude=.git"
      when: inventory_hostname != 'localhost'

    - name: Synchronize control repository for local bootstrap
      tags:
        - sync
      ansible.posix.synchronize:
        src: "{{ playbook_dir }}/../../"
        dest: /opt/cluster-infra/
        rsync_opts:
          - "--exclude=.git"
      when: inventory_hostname == 'localhost'
  roles:
    - role: system_deps
      tags:
        - system_deps
    - role: common
      tags:
        - common
