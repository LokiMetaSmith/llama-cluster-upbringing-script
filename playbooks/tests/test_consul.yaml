- name: Test Consul Deployment
  hosts: all
  become: no
  gather_facts: no

  tasks:
    - name: Import the Consul playbook
      ansible.builtin.import_playbook: ../services/consul.yaml

    - name: Check if the Consul service is running
      ansible.builtin.systemd:
        name: consul
      register: consul_service_status
      failed_when: "consul_service_status.status.ActiveState != 'active'"
      changed_when: false

    - name: Wait for a Consul leader to be elected
      ansible.builtin.uri:
        url: "http://127.0.0.1:8500/v1/status/leader"
        return_content: yes
      register: consul_leader_status
      until: consul_leader_status.content != '""' and consul_leader_status.status == 200
      retries: 1
      delay: 1
      ignore_errors: yes

    - name: Fail if no Consul leader is found
      ansible.builtin.fail:
        msg: "Consul leader not found."
      when: consul_leader_status.failed or consul_leader_status.content == '""'
