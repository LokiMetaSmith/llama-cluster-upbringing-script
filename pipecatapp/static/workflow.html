<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="description" content="Workflow Editor">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workflow Editor</title>
    <link rel="stylesheet" href="/static/css/litegraph.css">
    <link rel="stylesheet" href="/static/css/styles.css">
    <style>
        body { margin: 0; padding: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        .container { display: flex; flex: 1; overflow: hidden; height: 100%; }
        #sidebar {
            width: 250px;
            border-right: 1px solid #333;
            background-color: #1e1e1e;
            color: #ddd;
            display: flex;
            flex-direction: column;
        }

        /* Sidebar Tabs */
        .sidebar-tabs {
            display: flex;
            background: #252526;
            border-bottom: 1px solid #333;
        }
        .sidebar-tab {
            flex: 1;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            font-size: 12px;
            background: #252526;
            color: #888;
            border: none;
            outline: none;
            font-family: inherit;
        }
        .sidebar-tab:focus-visible {
            background-color: #2a2d2e;
            outline: 1px solid #007acc;
            outline-offset: -1px;
        }
        .sidebar-tab.active {
            background: #1e1e1e;
            color: #fff;
            border-bottom: 2px solid #007acc;
        }

        .sidebar-content {
            flex: 1;
            display: none;
            flex-direction: column;
            overflow: hidden;
        }
        .sidebar-content.active {
            display: flex;
        }

        #sidebar h2 { padding: 10px; margin: 0; background: #252526; font-size: 14px; text-transform: uppercase; }

        /* History List */
        #history-list { list-style: none; padding: 0; margin: 0; overflow-y: auto; flex: 1; }
        .history-item { padding: 8px 10px; border-bottom: 1px solid #333; cursor: pointer; font-size: 12px; }
        .history-item:hover { background-color: #2a2d2e; }
        .history-item.active { background-color: #37373d; border-left: 3px solid #007acc; }
        .history-meta { color: #888; font-size: 10px; margin-top: 2px; }

        /* Node Library */
        #node-library { list-style: none; padding: 0; margin: 0; overflow-y: auto; flex: 1; }
        .node-item {
            padding: 8px 10px;
            border-bottom: 1px solid #333;
            cursor: grab;
            font-size: 12px;
            display: flex;
            align-items: center;
        }
        .node-item:hover { background-color: #2a2d2e; }
        .node-item::before {
            content: '';
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #0e639c;
            margin-right: 8px;
        }

        #main-content { flex-grow: 1; position: relative; display: flex; flex-direction: column; }
        #toolbar {
            height: 40px;
            background-color: #252526;
            border-bottom: 1px solid #333;
            display: flex;
            align-items: center;
            padding: 0 10px;
        }
        #toolbar button {
            background: #0e639c;
            border: none;
            color: white;
            padding: 6px 12px;
            margin-right: 10px;
            cursor: pointer;
            font-size: 12px;
            border-radius: 2px;
        }
        #toolbar button:hover { background: #1177bb; }
        #toolbar span { color: #ccc; margin-left: auto; font-size: 12px; }
        /* Palette UX: Status colors */
        .status-success { color: #28a745 !important; transition: color 0.3s; }
        .status-error { color: #dc3545 !important; transition: color 0.3s; }
        .status-info { color: #007acc !important; transition: color 0.3s; }
        .status-ready { color: #ccc; transition: color 0.3s; }

        /* Palette UX: Empty State */
        .empty-state {
            padding: 20px;
            color: #888;
            font-style: italic;
            text-align: center;
            font-size: 13px;
        }

        #editor-canvas { width: 100%; height: 100%; background-color: #1e1e1e; }
    </style>
</head>
<body>
    <div class="container">
        <div id="sidebar">
            <div class="sidebar-tabs" role="tablist" aria-label="Sidebar Sections">
                <button class="sidebar-tab active" role="tab" aria-selected="true" aria-controls="tab-library" id="tab-btn-library" data-target="tab-library">Library</button>
                <button class="sidebar-tab" role="tab" aria-selected="false" aria-controls="tab-history" id="tab-btn-history" data-target="tab-history">History</button>
            </div>

            <!-- Library Tab -->
            <div id="tab-library" class="sidebar-content active" role="tabpanel" aria-labelledby="tab-btn-library">
                <div style="padding: 10px; border-bottom: 1px solid #333;">
                    <input type="text" id="node-search" placeholder="Search nodes..." aria-label="Search nodes" style="width: 100%; padding: 5px; background: #333; border: 1px solid #444; color: #fff;">
                </div>
                <ul id="node-library">
                    <!-- Nodes will be populated here -->
                </ul>
            </div>

            <!-- History Tab -->
            <div id="tab-history" class="sidebar-content" role="tabpanel" aria-labelledby="tab-btn-history">
                <div id="controls" style="padding: 10px; border-bottom: 1px solid #333;">
                    <button id="live-btn" style="width: 100%; margin-bottom: 5px;">Go Live / Poll</button>
                    <button id="refresh-history-btn" style="width: 100%;">Refresh History</button>
                </div>
                <ul id="history-list" role="listbox" aria-label="History List"></ul>
            </div>
        </div>
        <div id="main-content">
            <div id="toolbar">
                <button id="save-btn">Save / Deploy</button>
                <button id="arrange-btn">Auto Arrange</button>
                <button id="vr-btn" onclick="window.location.href='/static/vr_index.html'" style="background-color: #800080;">Enter VR</button>
                <span id="status-text" role="status" aria-live="polite">Ready</span>
            </div>
            <canvas id="editor-canvas"></canvas>
        </div>
    </div>

    <script src="/static/js/litegraph.js"></script>
    <script src="/static/js/editor.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const statusText = document.getElementById('status-text');

            // Palette UX: Helper for non-blocking status updates
            let statusTimeout;
            function showStatus(message, type = 'info') {
                if (statusTimeout) clearTimeout(statusTimeout);
                statusText.textContent = message;
                statusText.className = ''; // clear previous
                if (type === 'success') statusText.classList.add('status-success');
                else if (type === 'error') statusText.classList.add('status-error');
                else if (type === 'info') statusText.classList.add('status-info');

                // Revert to ready after 3 seconds
                statusTimeout = setTimeout(() => {
                    statusText.textContent = "Ready";
                    statusText.className = 'status-ready';
                }, 3000);
            }

            // Initialize Editor with status callback
            WorkflowEditor.init("editor-canvas", {
                onStatusUpdate: showStatus
            });

            // Load Default Workflow
            try {
                const response = await fetch('/api/workflows/definition/default_agent_loop.yaml');
                const yamlData = await response.json();
                WorkflowEditor.importWorkflow(yamlData);
            } catch (e) {
                console.error("Failed to load default workflow", e);
            }

            // Tab Logic
            document.querySelectorAll('.sidebar-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    // Remove active class from all tabs and content
                    document.querySelectorAll('.sidebar-tab').forEach(t => {
                        t.classList.remove('active');
                        t.setAttribute('aria-selected', 'false');
                    });
                    document.querySelectorAll('.sidebar-content').forEach(c => c.classList.remove('active'));

                    // Add active class to clicked tab and target content
                    tab.classList.add('active');
                    tab.setAttribute('aria-selected', 'true');
                    document.getElementById(tab.dataset.target).classList.add('active');
                });
            });

            // Populate Node Library
            const nodeLibrary = document.getElementById('node-library');
            const searchInput = document.getElementById('node-search');

            function populateLibrary(filter = "") {
                nodeLibrary.innerHTML = "";
                const registeredTypes = WorkflowEditor.getRegisteredNodeTypes();
                const filteredTypes = registeredTypes.filter(type => type.toLowerCase().includes(filter.toLowerCase()));

                if (filteredTypes.length === 0) {
                    const li = document.createElement('li');
                    li.className = 'empty-state';
                    li.textContent = filter ? "No nodes found matching '" + filter + "'" : "No nodes available";
                    nodeLibrary.appendChild(li);
                    return;
                }

                filteredTypes.forEach(type => {
                    const li = document.createElement('li');
                    li.className = 'node-item';
                    li.textContent = type.replace("agent/", ""); // Clean up name
                    li.draggable = true;

                    // Palette UX: Accessibility for keyboard users
                    li.tabIndex = 0;
                    li.setAttribute('role', 'button');
                    li.setAttribute('aria-label', "Add " + li.textContent + " node");

                    li.addEventListener('dragstart', (e) => {
                        e.dataTransfer.setData('nodeType', type);
                    });

                    // Palette UX: Allow adding via keyboard
                    li.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter' || e.key === ' ') {
                            e.preventDefault();
                            addNodeToCenter(type);
                        }
                    });

                    nodeLibrary.appendChild(li);
                });
            }

            // Palette UX: Helper to add node to center of view
            function addNodeToCenter(type) {
                if (!WorkflowEditor.graph || !WorkflowEditor.canvas) return;

                const node = LiteGraph.createNode(type);
                if (!node) return;

                const canvas = WorkflowEditor.canvas;
                // Calculate center based on current canvas transform (ds)
                let x = 400;
                let y = 300;

                if (canvas.ds) {
                    const w = canvas.bgcanvas ? canvas.bgcanvas.width : 800;
                    const h = canvas.bgcanvas ? canvas.bgcanvas.height : 600;

                    x = (-canvas.ds.offset[0] + w / 2) / canvas.ds.scale;
                    y = (-canvas.ds.offset[1] + h / 2) / canvas.ds.scale;
                }

                node.pos = [x, y];
                WorkflowEditor.graph.add(node);
                showStatus(`Added ${type.replace("agent/", "")} node`, 'success');

                if (WorkflowEditor.canvas.selectNode) {
                    WorkflowEditor.canvas.selectNode(node);
                }
            }

            populateLibrary();

            searchInput.addEventListener('input', (e) => {
                populateLibrary(e.target.value);
            });

            // Buttons
            document.getElementById('save-btn').addEventListener('click', async () => {
                const btn = document.getElementById('save-btn');
                const originalText = btn.innerHTML;

                try {
                    btn.innerHTML = '<span class="spinner" style="margin-right: 8px;"></span> Saving...';
                    btn.disabled = true;
                    await WorkflowEditor.saveWorkflow();
                } finally {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            });

            document.getElementById('arrange-btn').addEventListener('click', () => {
                WorkflowEditor.autoLayout();
            });

            // Live Polling Logic
            let pollingInterval = null;
            const liveBtn = document.getElementById('live-btn');

            function startPolling() {
                liveBtn.textContent = "Stop Live View";
                liveBtn.style.backgroundColor = "#28a745";
                pollingInterval = setInterval(async () => {
                    try {
                        const res = await fetch('/api/workflows/active');
                        const data = await res.json();
                        // Get first active workflow state
                        const runIds = Object.keys(data);
                        if (runIds.length > 0) {
                            WorkflowEditor.updateLiveStatus(data[runIds[0]]);
                            document.getElementById('status-text').textContent = "Running: " + runIds[0];
                        } else {
                            document.getElementById('status-text').textContent = "No active workflows";
                        }
                    } catch (e) { console.error(e); }
                }, 1000);
            }

            function stopPolling() {
                liveBtn.textContent = "Go Live / Poll";
                liveBtn.style.backgroundColor = "";
                if (pollingInterval) clearInterval(pollingInterval);
                pollingInterval = null;
            }

            liveBtn.addEventListener('click', () => {
                if (pollingInterval) stopPolling();
                else startPolling();
            });

            // History Logic
            const historyList = document.getElementById('history-list');

            async function loadHistory() {
                const res = await fetch('/api/workflows/history?limit=20');
                const runs = await res.json();
                historyList.innerHTML = '';
                runs.forEach(run => {
                    const li = document.createElement('li');
                    li.className = 'history-item';
                    li.tabIndex = 0;
                    li.setAttribute('role', 'option');
                    li.setAttribute('aria-selected', 'false');
                    li.innerHTML = `
                        <div>${new Date(run.start_time * 1000).toLocaleTimeString()}</div>
                        <div class="history-meta">${run.id.substring(0,8)}...</div>
                    `;

                    const handleClick = async () => {
                        // Mark active
                        document.querySelectorAll('.history-item').forEach(i => {
                            i.classList.remove('active');
                            i.setAttribute('aria-selected', 'false');
                        });
                        li.classList.add('active');
                        li.setAttribute('aria-selected', 'true');

                        console.log("Loading run", run);
                        // Fetch full details
                        try {
                            const detailRes = await fetch(`/api/workflows/history/${run.id}`);
                            if (!detailRes.ok) throw new Error("Run not found");
                            const fullRun = await detailRes.json();

                            // Visualize
                            WorkflowEditor.visualizeRun(fullRun);
                        } catch(e) {
                            console.error(e);
                            showStatus("Failed to load run details", "error");
                        }
                    };

                    li.onclick = handleClick;
                    li.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter' || e.key === ' ') {
                            e.preventDefault();
                            handleClick();
                        }
                    });

                    historyList.appendChild(li);
                });
            }

            document.getElementById('refresh-history-btn').addEventListener('click', loadHistory);
            loadHistory();
        });
    </script>
</body>
</html>
