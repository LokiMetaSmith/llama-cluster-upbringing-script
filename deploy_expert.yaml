---
- hosts: localhost
  connection: local
  gather_facts: no

  # These variables would be passed on the command line with -e
  # e.g., ansible-playbook deploy_expert.yaml -e "job_name=my-expert ..."
  vars:
    job_name: "default-expert"
    service_name: "prima-api-default"
    namespace: "default"
    model_list: "{{ main_expert_models }}"
    worker_count: 1

  tasks:
    - name: "Render the Prima Expert job template with custom variables"
      ansible.builtin.template:
        src: ansible/jobs/prima-expert.nomad
        dest: /tmp/{{ job_name }}.nomad
        mode: '0644'

    - name: "Run the custom Prima Expert job in Nomad"
      ansible.builtin.command:
        cmd: "nomad job run /tmp/{{ job_name }}.nomad"
      register: nomad_run_result
      changed_when: "'Eval ID' in nomad_run_result.stdout"

    - name: "Display Nomad run output"
      ansible.builtin.debug:
        var: nomad_run_result.stdout_lines
