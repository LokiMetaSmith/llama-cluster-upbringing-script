- name: E2E Cluster Health Check
  hosts: all
  gather_facts: false
  tasks:
    - name: Check that Consul is running and has a leader
      ansible.builtin.uri:
        url: "http://{{ ansible_host }}:8500/v1/status/leader"
        return_content: yes
      register: consul_leader
      failed_when: consul_leader.content == '""'

    - name: Check that Nomad is running and has a leader
      ansible.builtin.uri:
        url: "http://{{ ansible_host }}:4646/v1/status/leader"
        return_content: yes
      register: nomad_leader
      failed_when: nomad_leader.content == '""'

    - name: Check that the pipecat application is running
      ansible.builtin.uri:
        url: "http://{{ ansible_host }}:8000/health"
        status_code: [200, 503]
      register: pipecat_status
      until: pipecat_status.status == 200
      retries: 30 # 30 retries * 10 seconds = 5 minutes
      delay: 10

    - name: Verify that the pipecat application is running with the Docker driver
      ansible.builtin.command: nomad job inspect pipecat-app
      register: pipecat_job_inspect
      changed_when: false

    - name: Assert that the driver is 'docker'
      ansible.builtin.assert:
        that:
          - "(pipecat_job_inspect.stdout | from_json).TaskGroups[0].Tasks[0].Driver == 'docker'"

- name: Llama.cpp Benchmark as an E2E Test
  hosts: controller_nodes
  tasks:
    - name: Run the llama-benchmark Nomad job
      ansible.builtin.command: nomad job run ansible/jobs/benchmark.nomad
      register: benchmark_run

    - name: Wait for the benchmark job to complete
      ansible.builtin.command: nomad job status llama-benchmark
      register: benchmark_status
      until: "'dead' in benchmark_status.stdout"
      retries: 20
      delay: 10

    - name: Get benchmark logs
      ansible.builtin.command: nomad job logs llama-benchmark
      register: benchmark_logs

    - name: Assert that the benchmark produced a result
      ansible.builtin.assert:
        that:
          - "'tokens/s' in benchmark_logs.stdout"

- name: Playwright-based Web UI E2E Test
  hosts: controller_nodes
  tasks:
    - name: Install Playwright browser dependencies
      ansible.builtin.command: python -m playwright install
      register: playwright_install
      changed_when: "'Browsers installed' in playwright_install.stdout"

    - name: Run Playwright tests with pytest
      ansible.builtin.command: python -m pytest tests/e2e/
      register: playwright_test_results
      changed_when: false # This task only reports status, doesn't change state

    - name: Display Playwright test results
      ansible.builtin.debug:
        var: playwright_test_results.stdout_lines

- name: E2E Agent Tool Call Test
  hosts: controller_nodes
  tasks:
    - name: Ask the agent for its status using the mcp_tool
      ansible.builtin.uri:
        url: "http://{{ ansible_host }}:8000/agent/chat"
        method: POST
        body_format: json
        body:
          text: "Use the mcp_tool to get your current status."
        return_content: yes
      register: agent_response

    - name: Assert that the agent returned a valid status report
      ansible.builtin.assert:
        that:
          - "'Current pipeline status' in agent_response.json.text or 'No active pipelines' in agent_response.json.text"
        fail_msg: "Agent did not return a valid status report. Response: {{ agent_response.json.text }}"

- name: E2E Project Mapper Tool Test
  hosts: controller_nodes
  tasks:
    - name: Ask the agent to map the project structure
      ansible.builtin.uri:
        url: "http://{{ ansible_host }}:8000/agent/chat"
        method: POST
        body_format: json
        body:
          text: "Use the project_mapper_tool to map the current directory structure."
        return_content: yes
      register: mapper_response
      retries: 3
      delay: 5

    - name: Assert that the agent returned a project map
      ansible.builtin.assert:
        that:
          - "'files' in mapper_response.json.text or 'structure' in mapper_response.json.text or 'ansible' in mapper_response.json.text"
        fail_msg: "Agent did not return a valid project map. Response: {{ mapper_response.json.text }}"

- import_playbook: ../integration/test_home_assistant.yaml
