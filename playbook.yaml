- name: Play 1 - Bootstrap New Nodes as 'root'
  hosts: all:!localhost
  remote_user:  "{{ ansible_user }}" # Connects as the user you specify on the command line
  become: yes # We are already root

  tasks:
    - name: Ensure the sudo package is installed
      ansible.builtin.apt:
        name: sudo
        state: present
        
    - name: Ensure the sudo group exists
      ansible.builtin.group:
        name: sudo
        state: present

    - name: Create the 'user' account with sudo access
      ansible.builtin.user:
        name: user
        shell: /bin/bash
        groups: sudo
        append: yes

    - name: Allow 'user' to have passwordless sudo access
      ansible.builtin.lineinfile:
        path: /etc/sudoers.d/ansible-user-nopasswd
        line: "user ALL=(ALL) NOPASSWD: ALL"
        create: yes
        validate: 'visudo -cf %s'
        mode: '0440'


- name: Play 2 - Configure Nodes as 'user'
  hosts: all
  remote_user: user
  become: yes # Now we use the sudo privileges we just created

  roles:
    - common
    - consul
    - docker
    - nomad
    - python_deps
    - llama_cpp
    - whisper_cpp
    - provisioning_api

  post_tasks:
    - name: Discover and save the MAC address for future use
      ansible.builtin.blockinfile:
        path: "host_vars/{{ inventory_hostname }}.yaml"
        create: yes
        block: |
          mac_address: "{{ ansible_default_ipv4.macaddress }}"
      delegate_to: localhost

