# tasks file for bootstrap_agent

- name: Force all pending handlers to run now
  meta: flush_handlers

# ============================
# Phase 1: Bootstrap Mode
# ============================

- block:
    - name: Wait for Nomad service to become active (bootstrap single node)
      ansible.builtin.command: systemctl is-active nomad
      register: nomad_service_status
      until: nomad_service_status.stdout == "active"
      retries: 12
      delay: 5
      changed_when: false
      check_mode: no
  when: ansible_connection == "local"

# ============================
# Phase 2: Cluster Mode
# ============================

- block:
    - name: Wait for Nomad service to become active (multi-node)
      ansible.builtin.command: systemctl is-active nomad
      register: nomad_service_status
      until: nomad_service_status.stdout == "active"
      retries: 12
      delay: 5
      changed_when: false
      check_mode: no

    - name: Wait for at least 1 Nomad peer
      ansible.builtin.uri:
        url: "http://{{ inventory_hostname }}:4646/v1/status/peers"
        return_content: yes
      register: nomad_peers
      until: nomad_peers.json | length >= 1
      retries: 20
      delay: 6
      changed_when: false

    - name: Check if full cluster size reached
      ansible.builtin.assert:
        that:
          - nomad_peers.json | length >= expected_cluster_size
        fail_msg: >
          Cluster has not reached expected size ({{ nomad_peers.json | length }}/{{ expected_cluster_size }}).
          Some nodes may still be booting (e.g. PXE workers).
        success_msg: "Nomad cluster has reached expected size."
      ignore_errors: true   # warn but donâ€™t fail hard
  when: ansible_connection != "local"

- name: Get Nomad peer status for summary
  ansible.builtin.uri:
    url: "http://127.0.0.1:4646/v1/status/peers"
    return_content: yes
  register: nomad_peers_summary
  when: ansible_connection == "local"

- name: Set expected cluster size
  ansible.builtin.set_fact:
    expected_cluster_size: "{{ groups['workers'] | default([]) | length }}"

- name: Force all pending handlers to run now
  meta: flush_handlers
- name: Set summary variable for local connection
  ansible.builtin.set_fact:
    nomad_peers: "{{ nomad_peers_summary }}"
  when: ansible_connection == "local"

- name: Print Nomad cluster members summary
  ansible.builtin.debug:
    msg: >
      Current cluster members ({{ nomad_peers.json | length }}/{{ expected_cluster_size }}):
      {{ nomad_peers.json | join(', ') }}
  when: nomad_peers_summary.skipped is not defined
