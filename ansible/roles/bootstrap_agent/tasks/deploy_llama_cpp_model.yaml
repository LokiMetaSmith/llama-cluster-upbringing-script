- name: Render the Llama.cpp RPC Nomad job from template for bootstrap
  ansible.builtin.template:
    src: "{{ playbook_dir }}/ansible/jobs/llamacpp-rpc.nomad.j2"
    dest: "{{ nomad_jobs_dir }}/llamacpp-rpc.nomad"
    mode: '0644'
  vars:
    job_name: "llamacpp-rpc"
    service_name: "llamacpp-rpc-api"
    nomad_namespace: "default"
    model_list: "{{ expert_models['main'] }}"
    worker_count: 1
  register: job_file

- name: Check if llamacpp-rpc job is running
  ansible.builtin.command:
    cmd: "nomad job status llamacpp-rpc"
  register: job_status
  failed_when: false
  changed_when: false
  environment:
    NOMAD_ADDR: "http://{{ cluster_ip }}:{{ nomad_http_port }}"

- name: Deploy the main Llama.cpp RPC service to Nomad
  ansible.builtin.command:
    cmd: "nomad job run -detach {{ nomad_jobs_dir }}/llamacpp-rpc.nomad"
  register: llama_job_run
  changed_when: "'Eval ID' in llama_job_run.stdout"
  failed_when: llama_job_run.rc != 0
  environment:
    NOMAD_ADDR: "http://{{ cluster_ip }}:{{ nomad_http_port }}"
  when: job_file.changed or job_status.rc != 0

- name: Check for Consul management token file
  ansible.builtin.stat:
    path: /etc/consul.d/management_token
  register: management_token_file
  become: yes
  when: consul_bootstrap_token is not defined or consul_bootstrap_token == ''

- name: Read Consul management token
  ansible.builtin.slurp:
    src: /etc/consul.d/management_token
  register: management_token_content
  become: yes
  when:
    - consul_bootstrap_token is not defined or consul_bootstrap_token == ''
    - management_token_file.stat.exists

- name: Set consul_bootstrap_token fact
  ansible.builtin.set_fact:
    consul_bootstrap_token: "{{ management_token_content.content | b64decode | trim }}"
  when:
    - consul_bootstrap_token is not defined or consul_bootstrap_token == ''
    - management_token_file.stat.exists
    - management_token_content.content is defined

- name: Wait for the main expert service to be healthy in Consul
  ansible.builtin.uri:
    url: "http://127.0.0.1:{{ consul_http_port }}/v1/health/service/llamacpp-rpc-api"
    headers:
      X-Consul-Token: "{{ consul_bootstrap_token | default(omit) }}"
    return_content: yes
  register: expert_health
  until: >
    expert_health.json is defined and
    expert_health.json | map(attribute='Checks') | flatten | selectattr('Status', 'equalto', 'passing') | list | length > 0
  retries: 60
  delay: 10
  changed_when: false
