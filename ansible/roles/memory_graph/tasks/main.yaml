- name: Ensure memory persistence directory exists
  file:
    path: /opt/pipecat/data/memory
    state: directory
    mode: '0755'
    owner: root
    group: root

- name: Build memory-graph service image
  community.docker.docker_image:
    name: "memory-graph-service:local"
    build:
      path: "{{ inventory_dir }}/pipecatapp/memory_graph_service"
      pull: yes
    source: build
    force_source: true

- name: Check if local registry is reachable
  ansible.builtin.wait_for:
    host: "{{ docker_registry_host }}"
    port: "{{ docker_registry_port }}"
    state: started
    timeout: 1
  register: registry_check
  ignore_errors: true

- name: Tag and push memory-graph service image to local registry
  community.docker.docker_image:
    name: "memory-graph-service:local"
    repository: "{{ docker_registry_host }}:{{ docker_registry_port }}/memory-graph-service:latest"
    push: true
    source: local
  when: registry_check is success

- name: Set memory_graph_image (Registry)
  ansible.builtin.set_fact:
    memory_graph_image: "{{ docker_registry_host }}:{{ docker_registry_port }}/memory-graph-service:latest"
  when: registry_check is success

- name: Set memory_graph_image (Local Fallback)
  ansible.builtin.set_fact:
    memory_graph_image: "memory-graph-service:local"
  when: registry_check is failed

- name: Deploy memory-graph Nomad job
  community.general.nomad_job:
    content: "{{ lookup('template', 'memory-graph.nomad.j2') }}"
    state: present
    host: localhost
    port: 4646
    use_ssl: false
