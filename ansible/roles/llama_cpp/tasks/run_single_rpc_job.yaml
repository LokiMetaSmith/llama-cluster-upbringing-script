- name: Find benchmark result for {{ model_item.filename }}
  ansible.builtin.set_fact:
    model_benchmark: "{{ benchmark_results | selectattr('model', 'equalto', model_item.filename) | first | default({}) }}"

- name: Set TPS fact for {{ model_item.filename }}
  ansible.builtin.set_fact:
    current_avg_tps: "{{ model_benchmark.tokens_per_second | default(0) }}"

- name: Template llamacpp-rpc job for {{ model_item.filename }}
  ansible.builtin.template:
    src: ../../jobs/llamacpp-rpc.nomad.j2
    dest: "/tmp/llamacpp-rpc-{{ model_item.filename | regex_replace('[^a-zA-Z0-9-]', '-') }}.nomad"
    mode: '0644'
  vars:
    # Pass necessary variables to the template
    job_name: "llamacpp-rpc-{{ model_item.filename | regex_replace('[^a-zA-Z0-9-]', '-') }}"
    item: "{{ model_item }}" # Pass the current model dict as 'item' for the template
    avg_tokens_per_second: "{{ current_avg_tps }}" # Pass the calculated TPS
    worker_count: 1 # Assuming 1 worker per model for RPC? Adjust if needed.

- name: Run llamacpp-rpc job for {{ model_item.filename }}
  ansible.builtin.command:
    cmd: "nomad job run /tmp/llamacpp-rpc-{{ model_item.filename | regex_replace('[^a-zA-Z0-9-]', '-') }}.nomad"
  register: rpc_job_run
  changed_when: "'Eval ID' in rpc_job_run.stdout"
  environment:
    NOMAD_ADDR: "http://{{ ansible_default_ipv4.address }}:4646"

- name: Clean up temporary job file for {{ model_item.filename }}
  ansible.builtin.file:
    path: "/tmp/llamacpp-rpc-{{ model_item.filename | regex_replace('[^a-zA-Z0-9-]', '-') }}.nomad"
    state: absent
