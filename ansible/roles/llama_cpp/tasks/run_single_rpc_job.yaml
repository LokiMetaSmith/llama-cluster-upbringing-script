- name: Find benchmark result for {{ model_item.filename }}
  ansible.builtin.set_fact:
    model_benchmark: "{{ benchmark_results | selectattr('model', 'equalto', model_item.filename) | first | default({}) }}"

- name: Set TPS fact for {{ model_item.filename }}
  ansible.builtin.set_fact:
    current_avg_tps: "{{ model_benchmark.tokens_per_second | default(0) }}"

- name: Template llamacpp-rpc job for {{ model_item.filename }}
  ansible.builtin.template:
    src: ../../jobs/llamacpp-rpc.nomad.j2
    dest: "/tmp/rpc-{{ model_item.filename | regex_replace('[^a-zA-Z0-9-]', '-') }}.nomad"
    mode: '0644'
  vars:
    # Pass necessary variables to the template
    job_name: "rpc-{{ model_item.filename | regex_replace('[^a-zA-Z0-9-]', '-') }}"
    model: "{{ model_item }}" # Pass the current model dict as 'model' for the template
    avg_tokens_per_second: "{{ current_avg_tps }}" # Pass the calculated TPS
    worker_count: 1 # Assuming 1 worker per model for RPC? Adjust if needed.

- name: Run llamacpp-rpc job for {{ model_item.filename }}
  block:
    - name: Deploy llamacpp-rpc job
      ansible.builtin.command:
        cmd: "/usr/local/bin/nomad job run /tmp/rpc-{{ model_item.filename | regex_replace('[^a-zA-Z0-9-]', '-') }}.nomad"
      register: rpc_job_run
      changed_when: "'Eval ID' in rpc_job_run.stdout"
      environment:
        NOMAD_ADDR: "http://{{ cluster_ip }}:{{ nomad_http_port }}"
  rescue:
    - name: Fetch Nomad allocations for debugging
      ansible.builtin.shell: >
        /usr/local/bin/nomad job allocs -json rpc-{{ model_item.filename | regex_replace('[^a-zA-Z0-9-]', '-') }} | jq -r 'sort_by(.CreateTime) | reverse | .[0].ID'
      register: alloc_id
      environment:
        NOMAD_ADDR: "http://{{ cluster_ip }}:{{ nomad_http_port }}"
      ignore_errors: yes

    - name: Fetch Nomad allocation logs
      ansible.builtin.command:
        cmd: "/usr/local/bin/nomad alloc logs {{ alloc_id.stdout }}"
      register: alloc_logs
      environment:
        NOMAD_ADDR: "http://{{ cluster_ip }}:{{ nomad_http_port }}"
      when: alloc_id.stdout != ""
      ignore_errors: yes

    - name: Display allocation logs
      ansible.builtin.debug:
        msg: "{{ alloc_logs.stdout_lines + alloc_logs.stderr_lines }}"
      when: alloc_id.stdout != "" and alloc_logs is defined

    - name: Fail task
      ansible.builtin.fail:
        msg: "Failed to deploy llamacpp-rpc job for {{ model_item.filename }}. Check logs above."

- name: Clean up temporary job file for {{ model_item.filename }}
  ansible.builtin.file:
    path: "/tmp/rpc-{{ model_item.filename | regex_replace('[^a-zA-Z0-9-]', '-') }}.nomad"
    state: absent
