---
- name: Clone llama.cpp repository
  git:
    repo: 'https://github.com/ggml-org/llama.cpp.git'
    dest: /home/user/llama.cpp
    version: master
    update: yes
    force: yes

- name: Configure llama.cpp build
  command: cmake -B build -DGGML_RPC=ON -DLLAMA_SERVER_SSL=ON
  args:
    chdir: /home/user/llama.cpp

- name: Build llama.cpp
  command: cmake --build build --config Release -j
  args:
    chdir: /home/user/llama.cpp

- name: Copy llama.cpp RPC Nomad job file
  template:
    src: ../../jobs/llamacpp-rpc.nomad
    dest: /home/user/llamacpp-rpc.nomad
  when: "'controller_nodes' in group_names"

- name: Copy benchmark Nomad job file
  template:
    src: ../../jobs/benchmark.nomad
    dest: /home/user/benchmark.nomad
  when: "'controller_nodes' in group_names"
