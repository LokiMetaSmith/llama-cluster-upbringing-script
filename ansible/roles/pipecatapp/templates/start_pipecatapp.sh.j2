#!/bin/bash
#
# Unified Wrapper Script for pipecatapp
#
# This script is generated by Ansible and ensures that the pipecat application
# is run correctly in both raw_exec and Docker environments.

# Exit immediately if a command exits with a non-zero status.
set -e

# Change to the application directory
cd "{{ pipecat_app_dir }}"

# Source environment variables if present
if [ -f "{{ pipecat_app_dir }}/pipecat.env" ]; then
    source "{{ pipecat_app_dir }}/pipecat.env"
fi

# Activate the virtual environment
source "{{ pipecat_app_dir }}/venv/bin/activate"

echo "--- Starting pipecat-app: $(date) ---"

{% if pipecat_deployment_style == 'raw_exec' %}
# For raw_exec, we manage our own log file.
LOG_FILE="{{ pipecat_log_file }}"
touch "$LOG_FILE"
exec "{{ pipecat_app_dir }}/venv/bin/python3" "{{ pipecat_app_dir }}/app.py" >> "$LOG_FILE" 2>&1
{% else %}
# For Docker, we log to stdout/stderr and let the container runtime handle it.
exec "{{ pipecat_app_dir }}/venv/bin/python3" "{{ pipecat_app_dir }}/app.py"
{% endif %}
