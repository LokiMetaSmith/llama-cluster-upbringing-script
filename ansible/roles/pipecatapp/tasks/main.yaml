- name: Install python3, pip, and venv system packages
  ansible.builtin.apt:
    name:
      - python3
      - python3-pip
      - python3-venv #<-- Make sure venv is installed
    state: present
  become: yes

- name: Create a virtual environment for the application
  ansible.builtin.command:
    # This path MUST match the 'executable' path in the task below
    cmd: python3 -m venv /home/user/pipecatapp_venv
    creates: /home/user/pipecatapp_venv/bin/pip
  become: no
  #become_user: "{{ ansible_user }}"


- name: Create a persistent temporary directory for pip builds
  ansible.builtin.file:
    path: /var/tmp/ansible_pip_build
    state: directory
    mode: '0777' # Make it world-writable like /tmp
    
- name: Copy requirements.txt
  copy:
    src: requirements.txt
    dest: /home/user/requirements.txt
    
- name: Install system dependencies for Python packages
  ansible.builtin.apt:
    name:
      - mecab
      - libmecab-dev
      - mecab-ipadic-utf8
      - portaudio19-dev
    state: present
  become: yes

- name: Install python dependencies with a custom temp directory
  block:
    - name: Install python dependencies into the virtual environment
      ansible.builtin.pip:
        requirements: /home/user/requirements.txt
        executable: /home/user/pipecatapp_venv/bin/pip3
  environment:
    TMPDIR: /var/tmp/ansible_pip_build
  #pip:
    #requirements: /home/user/requirements.txt
    # This is the key: point to the pip inside your venv
    #executable: /home/user/pipecat_venv/bin/pip3

- name: Copy pipecat app
  copy:
    src: app.py
    dest: /home/user/app.py

- name: Copy pipecat Nomad job file
  template:
    src: ../../jobs/pipecatapp.nomad
    dest: /home/user/pipecatapp.nomad
  when: "'controller_nodes' in group_names"

- name: Install Playwright browsers using the virtual environment's python
  command:
    # Use the python from the venv to run the command
    cmd: /home/user/pipecat_venv/bin/python3 -m playwright install
  become: yes
  become_user: "{{ ansible_user }}"
