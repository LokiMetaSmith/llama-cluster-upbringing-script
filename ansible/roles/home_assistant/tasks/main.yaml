- name: Ensure Home Assistant config directory exists
  ansible.builtin.file:
    path: "{{ nomad_volumes_dir }}/ha-config"
    state: directory
    owner: "{{ home_assistant_uid | default(568) }}"
    group: "{{ home_assistant_gid | default(568) }}"
    mode: '0775'
    recurse: yes
  become: yes

- name: Template home-assistant Nomad job file
  ansible.builtin.template:
    src: home_assistant.nomad.j2
    dest: "{{ nomad_jobs_dir }}/home-assistant.nomad"
    mode: '0644'
  become: yes

- name: Template Home Assistant configuration
  ansible.builtin.template:
    src: configuration.yaml.j2
    dest: "{{ nomad_volumes_dir }}/ha-config/configuration.yaml"
    mode: '0644'
  become: yes

- name: Wait for Nomad API to be ready before submitting job
  ansible.builtin.uri:
    url: "http://{{ ansible_facts['default_ipv4']['address'] }}:4646/v1/status/leader"
    method: GET
    status_code: 200
  register: home_assistant_nomad_api_status
  until: home_assistant_nomad_api_status.status == 200
  retries: 12 # ~1 minute
  delay: 5
  changed_when: false
  become: no # Should be accessible locally

- name: Fetch Consul management token
  ansible.builtin.slurp:
    src: /etc/consul.d/management_token
  register: home_assistant_consul_token
  become: yes

- name: Debug Consul token
  ansible.builtin.debug:
    msg: "Token length: {{ (home_assistant_consul_token.content | b64decode | trim) | length }}"
  when: home_assistant_consul_token.content is defined

- name: Wait for MQTT service to be available in Consul before starting HA
  ansible.builtin.uri:
    url: "http://{{ ansible_facts['default_ipv4']['address'] }}:8500/v1/health/service/mqtt?passing"
    headers:
      X-Consul-Token: "{{ home_assistant_consul_token.content | b64decode | trim }}"
    return_content: yes
  register: home_assistant_mqtt_health
  until: home_assistant_mqtt_health.json is defined and home_assistant_mqtt_health.json | length > 0
  retries: 30 # ~5 minutes
  delay: 10
  changed_when: false
  become: no # Should be accessible locally

- name: Run home-assistant job asynchronously
  ansible.builtin.command:
    cmd: /usr/local/bin/nomad job run {{ nomad_jobs_dir }}/home-assistant.nomad
  environment:
    NOMAD_ADDR: "http://{{ ansible_default_ipv4.address }}:4646"
  changed_when: true
  become: no # Run nomad client as the ansible user
  async: 300
  poll: 0
  register: home_assistant_ha_job_run_status

- name: Log job submission status
  ansible.builtin.debug:
    var: home_assistant_ha_job_run_status
