- name: Ensure Nomad volumes directory exists
  ansible.builtin.file:
    path: "{{ nomad_volumes_dir }}"
    state: directory
    mode: '0755'
  become: yes

- name: Ensure Mosquitto directories exist
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: '0755'
  become: yes
  loop:
    - "{{ nomad_volumes_dir }}/mqtt-data"
    - "{{ nomad_volumes_dir }}/mqtt-data/data"
    - "{{ nomad_volumes_dir }}/mqtt-data/log"
    - "{{ nomad_volumes_dir }}/mqtt-data/config"

- name: Create Mosquitto config file
  ansible.builtin.copy:
    dest: "{{ nomad_volumes_dir }}/mqtt-data/config/mosquitto.conf"
    content: |
      persistence true
      persistence_location /mosquitto/data/
      log_dest stdout
      log_type all
      listener {{ mqtt_port }} 0.0.0.0
      allow_anonymous true
      listener {{ mqtt_websocket_port }} 0.0.0.0
      protocol websockets
    mode: '0644'
  become: yes

- name: Set ownership for Mosquitto directories
  ansible.builtin.file:
    path: "{{ nomad_volumes_dir }}/mqtt-data"
    state: directory
    owner: "1883"
    group: "1883"
    recurse: yes
  become: yes

- name: Flush handlers to ensure nomad is restarted and ready
  ansible.builtin.meta: flush_handlers

- name: Fetch Consul management token (if undefined)
  ansible.builtin.slurp:
    src: /etc/consul.d/management_token
  register: consul_token_file_mqtt
  delegate_to: "{{ (groups['controller_nodes'] | first) if ('controller_nodes' in groups and groups['controller_nodes']) else inventory_hostname }}"
  become: yes
  until: consul_token_file_mqtt is success
  retries: 5
  delay: 2
  when: consul_bootstrap_token is undefined
  ignore_errors: yes

- name: Set Consul token fact (if undefined)
  set_fact:
    consul_bootstrap_token: "{{ consul_token_file_mqtt['content'] | b64decode | trim }}"
  when: consul_bootstrap_token is undefined and consul_token_file_mqtt is success and consul_token_file_mqtt.content is defined

- name: Check Nomad Consul integration status
  ansible.builtin.command:
    cmd: /usr/local/bin/nomad node status -self -json
  environment:
    NOMAD_ADDR: "http://{{ cluster_ip }}:{{ nomad_http_port }}"
  register: nomad_status_json
  changed_when: false
  ignore_errors: yes

- name: Fix Nomad Consul integration if missing
  when: nomad_status_json.stdout is defined and 'consul.version' not in (nomad_status_json.stdout | from_json).get('Attributes', {})
  block:
    - name: Debug Consul Token
      ansible.builtin.debug:
        msg: "Consul token is: {{ 'DEFINED' if consul_bootstrap_token is defined and consul_bootstrap_token | length > 0 else 'UNDEFINED/EMPTY' }}"

    - name: Check server.hcl for token
      ansible.builtin.command: grep "token" /etc/nomad.d/server.hcl
      register: server_hcl_token
      become: yes
      ignore_errors: yes
      changed_when: false

    - name: Debug server.hcl token presence
      ansible.builtin.debug:
        var: server_hcl_token.stdout_lines

    - name: Verify Consul Leader Status
      ansible.builtin.uri:
        url: "http://127.0.0.1:{{ consul_http_port }}/v1/status/leader"
        return_content: yes
      register: consul_leader_check
      ignore_errors: yes

    - name: Debug Consul Leader
      ansible.builtin.debug:
        var: consul_leader_check

    - name: Verify Consul Token Validity
      ansible.builtin.uri:
        url: "http://127.0.0.1:{{ consul_http_port }}/v1/agent/self"
        headers:
          X-Consul-Token: "{{ consul_bootstrap_token }}"
        return_content: yes
      register: consul_token_check
      ignore_errors: yes

    - name: Debug Consul Token Check
      ansible.builtin.debug:
        var: consul_token_check

    - name: Fetch Nomad Logs (Pre-Restart)
      ansible.builtin.shell: "journalctl -u nomad -n 200 --no-pager | grep -i consul"
      register: nomad_logs_consul
      ignore_errors: yes
      become: yes

    - name: Display Nomad Consul Logs
      ansible.builtin.debug:
        var: nomad_logs_consul.stdout_lines

    - name: Force restart Nomad to pick up Consul config
      ansible.builtin.systemd:
        name: nomad
        state: restarted
      become: yes

    - name: Wait for Nomad API to be ready after restart
      ansible.builtin.uri:
        url: "http://{{ cluster_ip }}:{{ nomad_http_port }}/v1/agent/self"
        status_code: 200
      register: nomad_api_status_fix
      until: nomad_api_status_fix.status == 200
      retries: 12
      delay: 5

- name: Check if mqtt job exists
  ansible.builtin.command:
    cmd: /usr/local/bin/nomad job status mqtt
  environment:
    NOMAD_ADDR: "http://{{ cluster_ip }}:{{ nomad_http_port }}"
  register: mqtt_job_check
  failed_when: false
  changed_when: false

- name: Purge mqtt job
  ansible.builtin.command:
    cmd: /usr/local/bin/nomad job stop -purge mqtt
  environment:
    NOMAD_ADDR: "http://{{ cluster_ip }}:{{ nomad_http_port }}"
  when: mqtt_job_check.rc == 0
  changed_when: true

- name: Template mqtt Nomad job file
  ansible.builtin.template:
    src: mqtt.nomad.j2
    dest: "{{ nomad_jobs_dir }}/mqtt.nomad"
  become: yes

- name: Wait for Nomad to be ready
  ansible.builtin.wait_for:
    host: "{{ cluster_ip }}"
    port: "{{ nomad_http_port }}"
    timeout: 60

- name: Deploy MQTT Job
  block:
    - name: Run mqtt job
      ansible.builtin.command:
        cmd: /usr/local/bin/nomad job run -detach {{ nomad_jobs_dir }}/mqtt.nomad
      environment:
        NOMAD_ADDR: "http://{{ cluster_ip }}:{{ nomad_http_port }}"
      changed_when: true
      register: mqtt_job_run
      #  notify: Restart Home Assistant

    - name: Wait for MQTT port to be open
      ansible.builtin.wait_for:
        host: "127.0.0.1"  # Force check on localhost to bypass alias/hairpin issues
        port: "{{ mqtt_port }}"
        timeout: 60
      become: no

    - name: Wait for MQTT service to be healthy in Consul
      ansible.builtin.uri:
        url: "http://127.0.0.1:{{ consul_http_port }}/v1/health/service/mqtt?passing"
        method: GET
        headers:
          X-Consul-Token: "{{ consul_bootstrap_token }}"
        return_content: yes
        status_code: 200
      register: consul_check
      until: consul_check.json | length > 0
      retries: 30
      delay: 2
  rescue:
    - name: Get MQTT job status
      ansible.builtin.command:
        cmd: /usr/local/bin/nomad job status -verbose mqtt
      environment:
        NOMAD_ADDR: "http://{{ cluster_ip }}:{{ nomad_http_port }}"
      register: mqtt_job_status
      ignore_errors: yes

    - name: Display MQTT job status
      ansible.builtin.debug:
        var: mqtt_job_status.stdout

    - name: Get Nomad Node Status (Debug)
      ansible.builtin.command:
        cmd: /usr/local/bin/nomad node status -self -verbose
      environment:
        NOMAD_ADDR: "http://{{ cluster_ip }}:{{ nomad_http_port }}"
      register: nomad_node_status
      ignore_errors: yes

    - name: Display Nomad Node Status
      ansible.builtin.debug:
        var: nomad_node_status.stdout

    - name: Get MQTT allocations
      ansible.builtin.command:
        cmd: /usr/local/bin/nomad job allocs -json mqtt
      environment:
        NOMAD_ADDR: "http://{{ cluster_ip }}:{{ nomad_http_port }}"
      register: mqtt_allocs
      ignore_errors: yes

    - name: Save MQTT allocations to temp file
      ansible.builtin.copy:
        content: "{{ mqtt_allocs.stdout }}"
        dest: "/tmp/mqtt_allocs.json"

    - name: Extract Allocation ID
      ansible.builtin.command: jq -r 'sort_by(.CreateTime) | reverse | .[0].ID' /tmp/mqtt_allocs.json
      register: mqtt_alloc_id
      ignore_errors: yes

    - name: Fetch MQTT logs (stdout)
      ansible.builtin.command:
        cmd: "/usr/local/bin/nomad alloc logs {{ mqtt_alloc_id.stdout }}"
      environment:
        NOMAD_ADDR: "http://{{ cluster_ip }}:{{ nomad_http_port }}"
      register: mqtt_logs_stdout
      ignore_errors: yes
      when: (mqtt_alloc_id.stdout | trim | length > 0) and (mqtt_alloc_id.stdout | trim != 'null')

    - name: Display MQTT logs (stdout)
      ansible.builtin.debug:
        var: mqtt_logs_stdout.stdout
      when: mqtt_logs_stdout.stdout is defined

    - name: Fetch MQTT logs (stderr)
      ansible.builtin.command:
        cmd: "/usr/local/bin/nomad alloc logs -stderr {{ mqtt_alloc_id.stdout }}"
      environment:
        NOMAD_ADDR: "http://{{ cluster_ip }}:{{ nomad_http_port }}"
      register: mqtt_logs_stderr
      ignore_errors: yes
      when: (mqtt_alloc_id.stdout | trim | length > 0) and (mqtt_alloc_id.stdout | trim != 'null')

    - name: Display MQTT logs (stderr)
      ansible.builtin.debug:
        var: mqtt_logs_stderr.stdout
      when: mqtt_logs_stderr.stdout is defined

    - name: Clean up temp file
      ansible.builtin.file:
        path: "/tmp/mqtt_allocs.json"
        state: absent

    - name: Fail after debugging
      ansible.builtin.fail:
        msg: "MQTT job failed to start. See logs above."

- name: Debug mqtt job run
  ansible.builtin.debug:
    var: mqtt_job_run

- name: Deploy MQTT Exporter
  block:
    - name: Template mqtt-exporter job
      ansible.builtin.template:
        src: mqtt-exporter.nomad.j2
        dest: "{{ nomad_jobs_dir }}/mqtt-exporter.nomad"
      become: yes

    - name: Run mqtt-exporter job
      ansible.builtin.command:
        cmd: /usr/local/bin/nomad job run {{ nomad_jobs_dir }}/mqtt-exporter.nomad
      environment:
        NOMAD_ADDR: "http://{{ cluster_ip }}:{{ nomad_http_port }}"
      changed_when: true
