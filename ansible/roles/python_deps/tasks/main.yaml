- name: Create a virtual environment for the application
  ansible.builtin.command:
    cmd: "python3 -m venv /opt/pipecatapp/venv"
    creates: "/opt/pipecatapp/venv/bin/pip"
  become: yes
  tags:
    - deploy_app

- name: Ensure correct ownership of the virtual environment
  ansible.builtin.file:
    path: "/opt/pipecatapp/venv"
    owner: "{{ target_user }}"
    group: "{{ target_user }}"
    recurse: yes
  become: yes
  tags:
    - deploy_app

- name: Copy requirements.txt to the application directory
  copy:
    src: requirements.txt
    dest: "/opt/pipecatapp/requirements.txt"
    owner: "{{ target_user }}"
    group: "{{ target_user }}"
  become: yes
  tags:
    - deploy_app

- name: Create a persistent temporary directory for pip builds
  ansible.builtin.file:
    path: /var/tmp/ansible_pip_build
    state: directory
    mode: '0777'
  become: yes
  tags:
    - deploy_app

- name: Install/Upgrade base python packages in venv
  ansible.builtin.pip:
    name:
      - pip
      - setuptools
      - wheel
    state: latest
    executable: "/opt/pipecatapp/venv/bin/pip3"
  become: yes
  become_user: "{{ target_user }}"
  tags:
    - deploy_app

- name: Install Cython separately to ensure it's available for other builds
  ansible.builtin.pip:
    name: cython
    state: latest
    executable: "/opt/pipecatapp/venv/bin/pip3"
  become: yes
  become_user: "{{ target_user }}"
  tags:
    - deploy_app

- name: Install uv for faster dependency resolution
  ansible.builtin.pip:
    name: uv
    state: latest
    executable: "/opt/pipecatapp/venv/bin/pip3"
  become: yes
  become_user: "{{ target_user }}"
  tags:
    - deploy_app

- name: Install python dependencies with uv
  ansible.builtin.command:
    cmd: "/opt/pipecatapp/venv/bin/uv pip install -r /opt/pipecatapp/requirements.txt --python /opt/pipecatapp/venv/bin/python"
  environment:
    TMPDIR: /var/tmp/ansible_pip_build
  async: 1200 # Should be sufficient with uv
  poll: 10
  become: yes
  become_user: "{{ target_user }}"
  tags:
    - deploy_app

- name: Verify llm_sandbox installation
  ansible.builtin.command:
    cmd: "/opt/pipecatapp/venv/bin/python3 -c 'import llm_sandbox'"
  become: yes
  become_user: "{{ target_user }}"
  tags:
    - deploy_app

- name: Clean up pip build directory
  ansible.builtin.file:
    path: /var/tmp/ansible_pip_build
    state: absent
  become: yes
  tags:
    - deploy_app
