- name: 1. Update apt package cache
  become: yes
  apt:
    update_cache: yes
    cache_valid_time: 3600 # Cache is valid for 1 hour

- name: 2. Install default Python dev and venv packages
  become: yes
  apt:
    name:
      - python3-dev
      - python3-venv
      - python3-pip
      - python3-virtualenv
      - portaudio19-dev
    state: present

- name: 3. Create a virtual environment for the target user
  ansible.builtin.shell:
    cmd: "sudo -u {{ target_user }} python3 -m venv /home/{{ target_user }}/.local"
    creates: "/home/{{ target_user }}/.local/bin/pip"
  become: yes

- name: 4. Copy requirements.txt to remote host
  copy:
    src: requirements.txt
    dest: "/home/{{ target_user }}/requirements.txt"
    owner: "{{ target_user }}"
    group: "{{ target_user }}"
  become: yes

- name: 5. Install python dependencies into the virtual environment
  ansible.builtin.shell:
    cmd: "sudo -u {{ target_user }} /home/{{ target_user }}/.local/bin/pip install -r /home/{{ target_user }}/requirements.txt"
  become: yes
