---
- name: 1. Clean up duplicate entry in sources.list
  become: yes
  ansible.builtin.lineinfile:
    path: /etc/apt/sources.list
    # This line is redundant, so we remove it
    line: 'deb http://deb.debian.org/debian/ trixie main non-free-firmware'
    state: absent

- name: 2. Ensure the complete sources.list entry is present
  become: yes
  ansible.builtin.lineinfile:
    path: /etc/apt/sources.list
    # This is the comprehensive line we want to keep
    line: 'deb http://deb.debian.org/debian trixie main contrib non-free non-free-firmware'
    state: present

- name: 3. Update apt cache
  become: yes
  apt:
    update_cache: yes
    cache_valid_time: 3600

- name: 4. Install package using a direct command (workaround)
  become: yes
  ansible.builtin.command: apt-get install -y software-properties-common
  args:
    # This makes the task idempotent. It won't run if the package is already installed.
    creates: /usr/bin/add-apt-repository
