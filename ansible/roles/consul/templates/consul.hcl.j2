data_dir = "{{ consul_data_dir }}"
bind_addr = "{{ ansible_default_ipv4.address }}"
client_addr = "0.0.0.0"

# Enable the UI
ui_config {
  enabled = true
}

# For a server, we need to specify the bootstrap_expect
{% if "'controller_nodes' in group_names" %}
server = true
# In a single-node setup (like when using the bootstrap.sh script),
# the inventory will only contain one host. In this case, we must set
# bootstrap_expect to 1 to allow the server to elect itself as leader.
{% if ansible_play_hosts_all | length == 1 %}
bootstrap_expect = 1
# A single server bootstraps itself and does not need to join anything.
{% else %}
# For multi-node setups, we expect a quorum of controller nodes.
bootstrap_expect = {{ groups['controller_nodes'] | length }}
retry_join = ["{{ hostvars[groups['controller_nodes'][0]]['ansible_host'] }}"]
{% endif %}
{% else %}
# This is a client node, so it should try to join the controller.
server = false
retry_join = ["{{ hostvars[groups['controller_nodes'][0]]['ansible_host'] }}"]
{% endif %}
