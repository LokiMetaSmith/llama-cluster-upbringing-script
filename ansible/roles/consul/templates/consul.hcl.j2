data_dir = "{{ consul_data_dir }}"
bind_addr = "{{ advertise_ip }}"
client_addr = "0.0.0.0"
leave_on_terminate = true
primary_datacenter = "{{ consul_datacenter }}"

verify_incoming = true
verify_outgoing = true
verify_server_hostname = true
ca_file = "{{ consul_config_dir }}/ca.pem"
cert_file = "{{ consul_config_dir }}/cert.pem"
key_file = "{{ consul_config_dir }}/key.pem"

acl = {
  enabled = true
  default_policy = "deny"
  down_policy = "extend-cache"
}

telemetry {
  prometheus_retention_time = "24h"
  disable_hostname = true
}

# Enable the UI
ui_config {
  enabled = true
}

# For a server, we need to specify the bootstrap_expect
{% if 'controller_nodes' in group_names %}
server = true
# In a single-node setup (like when using the bootstrap.sh script),
# the inventory will only contain one host. In this case, we must set
# bootstrap_expect to 1 to allow the server to elect itself as leader.
{% if groups['controller_nodes'] | length == 1 %}
bootstrap_expect = 1
# A single server bootstraps itself and does not need to join anything.
{% else %}
# For multi-node setups, we expect a quorum of controller nodes.
bootstrap_expect = {{ groups['controller_nodes'] | length }}
retry_join = ["{{ hostvars[groups['controller_nodes'][0]]['ansible_host'] }}"]
{% endif %}
{% else %}
# This is a client node, so it should try to join the controller.
server = false
retry_join = ["{{ hostvars[groups['controller_nodes'][0]]['ansible_host'] }}"]
{% endif %}
