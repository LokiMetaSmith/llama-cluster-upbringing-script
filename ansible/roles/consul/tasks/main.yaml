- name: Install unzip
  apt:
    name: unzip
    state: present
  become: yes

- name: Check installed Consul version
  command: "consul version"
  register: consul_version_output
  changed_when: false
  failed_when: false

- name: Set installed Consul version fact
  set_fact:
    installed_consul_version: "{{ (consul_version_output.stdout | regex_search('Consul v([0-9]+\\.[0-9]+\\.[0-9]+)', '\\\\1') | first) if consul_version_output.rc == 0 else '0.0.0' }}"

- name: Download Consul
  command: "curl -L -o /tmp/consul.zip {{ consul_zip_url }}"
  args:
    creates: /tmp/consul.zip
  check_mode: no
  when: installed_consul_version != consul_version

- name: Unzip Consul
  unarchive:
    src: "/tmp/consul.zip"
    dest: "/tmp"
    remote_src: yes
    creates: /tmp/consul
  become: yes
  check_mode: no
  when: installed_consul_version != consul_version

- name: Move Consul to /usr/local/bin
  copy:
    src: /tmp/consul
    dest: /usr/local/bin/consul
    remote_src: yes
    mode: '0755'
  become: yes
  when: installed_consul_version != consul_version

- name: Create Consul data directory
  file:
    path: "{{ consul_data_dir }}"
    state: directory
    mode: '0755'
  become: yes

- name: Create Consul config directory
  file:
    path: "{{ consul_config_dir }}"
    state: directory
    mode: '0755'
  become: yes

- name: Generate certificates on localhost
  block:
    - name: Create local certs directory
      file:
        path: "{{ consul_temp_cert_dir }}"
        state: directory

    - name: Generate CA key
      command: "openssl genrsa -out {{ consul_temp_cert_dir }}/ca.key 2048"
      args:
        creates: "{{ consul_temp_cert_dir }}/ca.key"

    - name: Generate CA certificate
      command: "openssl req -new -x509 -days 3650 -key {{ consul_temp_cert_dir }}/ca.key -out {{ consul_temp_cert_dir }}/ca.pem -subj '/CN=Consul CA'"
      args:
        creates: "{{ consul_temp_cert_dir }}/ca.pem"

    - name: Generate server keys for controller nodes
      command: "openssl genrsa -out {{ consul_temp_cert_dir }}/{{ item }}.key 2048"
      args:
        creates: "{{ consul_temp_cert_dir }}/{{ item }}.key"
      loop: "{{ groups['controller_nodes'] }}"

    - name: Generate server CSRs for controller nodes
      command: "openssl req -new -key {{ consul_temp_cert_dir }}/{{ item }}.key -out {{ consul_temp_cert_dir }}/{{ item }}.csr -subj '/CN=server.consul'"
      args:
        creates: "{{ consul_temp_cert_dir }}/{{ item }}.csr"
      loop: "{{ groups['controller_nodes'] }}"

    - name: Sign server certificates for controller nodes
      command: "openssl x509 -req -in {{ consul_temp_cert_dir }}/{{ item }}.csr -CA {{ consul_temp_cert_dir }}/ca.pem -CAkey {{ consul_temp_cert_dir }}/ca.key -CAcreateserial -out {{ consul_temp_cert_dir }}/{{ item }}.pem -days 365"
      args:
        creates: "{{ consul_temp_cert_dir }}/{{ item }}.pem"
      loop: "{{ groups['controller_nodes'] }}"

    - name: Generate client keys for client nodes
      command: "openssl genrsa -out {{ consul_temp_cert_dir }}/{{ item }}.key 2048"
      args:
        creates: "{{ consul_temp_cert_dir }}/{{ item }}.key"
      loop: "{{ query('inventory_hostnames', 'all:!controller_nodes') }}"

    - name: Generate client CSRs for client nodes
      command: "openssl req -new -key {{ consul_temp_cert_dir }}/{{ item }}.key -out {{ consul_temp_cert_dir }}/{{ item }}.csr -subj '/CN=client.consul'"
      args:
        creates: "{{ consul_temp_cert_dir }}/{{ item }}.csr"
      loop: "{{ query('inventory_hostnames', 'all:!controller_nodes') }}"

    - name: Sign client certificates for client nodes
      command: "openssl x509 -req -in {{ consul_temp_cert_dir }}/{{ item }}.csr -CA {{ consul_temp_cert_dir }}/ca.pem -CAkey {{ consul_temp_cert_dir }}/ca.key -CAcreateserial -out {{ consul_temp_cert_dir }}/{{ item }}.pem -days 365"
      args:
        creates: "{{ consul_temp_cert_dir }}/{{ item }}.pem"
      loop: "{{ query('inventory_hostnames', 'all:!controller_nodes') }}"
  delegate_to: localhost
  run_once: true

- name: Include TLS tasks
  include_tasks: tls.yaml

- name: Include ACL tasks
  include_tasks: acl.yaml

- name: Copy Consul config
  template:
    src: consul.hcl.j2
    dest: "{{ consul_config_dir }}/consul.hcl"
  notify: restart consul
  become: yes

- name: Copy Consul systemd service file
  template:
    src: consul.service.j2
    dest: /etc/systemd/system/consul.service
  notify: restart consul
  become: yes

- name: Reload systemd to recognize new service
  systemd:
    daemon_reload: yes
  become: yes
  when: not ansible_check_mode

- name: Start and enable Consul service
  systemd:
    name: consul
    state: started
    enabled: yes
  become: yes
  when: not ansible_check_mode

- name: Clean up temporary certificate directory
  file:
    path: "{{ consul_temp_cert_dir }}"
    state: absent
  delegate_to: localhost
  run_once: true
