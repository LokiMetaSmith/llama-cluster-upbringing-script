# Task 0: Cleanup previous installation if requested
- name: Stop Consul if cleanup requested
  become: true
  ansible.builtin.systemd:
    name: consul
    state: stopped
  when: cleanup_services | default(false) | bool
  failed_when: false
  tags:
    - consul_configure

- name: Wait for Consul to stop if cleanup requested
  become: true
  ansible.builtin.shell: "pgrep consul"
  register: consul_pid
  until: consul_pid.rc != 0
  retries: 10
  delay: 2
  failed_when: false
  changed_when: false
  when: cleanup_services | default(false) | bool
  tags:
    - consul_configure

- name: Wait for Consul port 8500 to close if cleanup requested
  ansible.builtin.wait_for:
    host: "127.0.0.1" # Explicitly check localhost since client_addr is 0.0.0.0
    port: 8500
    state: stopped
    delay: 5 # Add delay to ensure systemd has fully processed the stop
    timeout: 30
    msg: "Timeout waiting for Consul port 8500 to close."
  when: cleanup_services | default(false) | bool
  tags:
    - consul_configure

- name: Wipe Consul Data and Tokens (Root cause of 403)
  become: true
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  loop:
    - "{{ consul_data_dir }}"              
    - "{{ consul_config_dir }}/management_token" 
  when: cleanup_services | default(false) | bool
  tags:
    - consul_configure

- name: Remove Consul data directory if cleanup requested
  become: true
  ansible.builtin.file:
    path: "{{ consul_data_dir }}"
    state: absent
  when: cleanup_services | default(false) | bool
  tags:
    - consul_configure

# Task 1: Install unzip (from user snippet)
- name: Install unzip
  become: true
  ansible.builtin.apt:
    name: unzip
    state: present
  tags:
    - consul_configure

- name: Check if consul executable exists
  stat:
    path: /usr/local/bin/consul
  register: consul_executable

# Task 2: Check version FIRST. This prevents the 'NoneType' error.
- name: Check installed Consul version
  ansible.builtin.command: consul --version
  register: consul_version_output
  changed_when: false
  failed_when: false # Do not fail if consul isn't found, we'll install it.
  tags:
    - consul_configure

# Task 3: Log the output for debugging (as requested)
- name: "Log Consul version command output (for debugging)"
  ansible.builtin.debug:
    msg:
      - "Jules Task Log: Debugging consul --version output."
      - "STDOUT: {{ consul_version_output.stdout | default('stdout was not defined or was None') }}"
      - "STDERR: {{ consul_version_output.stderr | default('stderr was not defined or was None') }}"
      - "RC: {{ consul_version_output.rc | default('rc was not defined') }}"
  when: consul_version_output is defined
  tags:
    - consul_configure

# Task 4: Download and install Consul (using user snippet's var/when logic)
- name: Download and install Consul
  become: true
  ansible.builtin.unarchive:
    src: "https://releases.hashicorp.com/consul/{{ consul_version }}/consul_{{ consul_version }}_linux_amd64.zip"
    dest: /usr/local/bin
    remote_src: yes
    owner: root
    group: root
    mode: 0755
  vars:
    # Define local var for use in 'when' condition. Use 'or' to default the version.
    current_version: "{{ (consul_version_output.stdout | regex_search('[0-9]+\\.[0-9]+\\.[0-9]+')) or '0.0.0' }}"
  when: current_version is version(consul_version, '<')
  tags:
    - consul_configure

# Task 5: Create consul group (best practice)
- name: Create consul group
  become: true
  ansible.builtin.group:
    name: consul
    state: present
  tags:
    - consul_configure

# Task 6: Create consul user (best practice)
- name: Create consul user
  become: true
  ansible.builtin.user:
    name: consul
    group: consul
    shell: /bin/false
    home: "{{ consul_config_dir }}" # Use config dir as home
    create_home: yes
  tags:
    - consul_configure

# Task 7: Create Consul data directory (from original, with ownership)
- name: Create Consul data directory
  become: true
  ansible.builtin.file:
    path: "{{ consul_data_dir }}"
    state: directory
    owner: consul
    group: consul
    mode: '0755'
  tags:
    - consul_configure

# Task 8: Create Consul config directory (from original, with ownership)
- name: Create Consul config directory
  become: true
  ansible.builtin.file:
    path: "{{ consul_config_dir }}"
    state: directory
    owner: consul
    group: consul
    mode: '0755'
  tags:
    - consul_configure

# Task 9: Generate certificates on localhost (from original file)
- name: Generate certificates on localhost
  block:
    - name: Ensure openssl is installed on localhost
      become: yes
      ansible.builtin.package:
        name: openssl
        state: present

    - name: Ensure local certs directory exists and is writable by user
      become: yes
      ansible.builtin.file:
        path: "{{ consul_temp_cert_dir }}"
        state: directory
        owner: "{{ ansible_user_id }}"
        mode: '0755'

    - name: Generate CA key
      ansible.builtin.command: "openssl genrsa -out {{ consul_temp_cert_dir }}/ca.key 2048"
      args:
        creates: "{{ consul_temp_cert_dir }}/ca.key"

    - name: Generate CA certificate
      ansible.builtin.command: "openssl req -new -x509 -days 3650 -key {{ consul_temp_cert_dir }}/ca.key -out {{ consul_temp_cert_dir }}/ca.pem -subj '/CN=Consul CA'"
      args:
        creates: "{{ consul_temp_cert_dir }}/ca.pem"

    # Server Certs
    - name: Generate OpenSSL config for server nodes
      ansible.builtin.copy:
        dest: "{{ consul_temp_cert_dir }}/{{ item }}.cnf"
        content: |
          [req]
          distinguished_name = req_distinguished_name
          req_extensions = v3_req
          prompt = no
          [req_distinguished_name]
          CN = server.consul
          [v3_req]
          keyUsage = keyEncipherment, dataEncipherment
          extendedKeyUsage = serverAuth, clientAuth
          subjectAltName = @alt_names
          [alt_names]
          DNS.1 = server.consul
          DNS.2 = localhost
          IP.1 = 127.0.0.1
          IP.2 = {{ hostvars[item]['cluster_ip'] }}
      loop: "{{ groups['controller_nodes'] }}"

    - name: Generate server keys for controller nodes
      ansible.builtin.command: "openssl genrsa -out {{ consul_temp_cert_dir }}/{{ item }}.key 2048"
      args:
        creates: "{{ consul_temp_cert_dir }}/{{ item }}.key"
      loop: "{{ groups['controller_nodes'] }}"

    - name: Generate server CSRs for controller nodes
      ansible.builtin.command: "openssl req -new -key {{ consul_temp_cert_dir }}/{{ item }}.key -out {{ consul_temp_cert_dir }}/{{ item }}.csr -config {{ consul_temp_cert_dir }}/{{ item }}.cnf"
      args:
        creates: "{{ consul_temp_cert_dir }}/{{ item }}.csr"
      loop: "{{ groups['controller_nodes'] }}"

    - name: Sign server certificates for controller nodes
      ansible.builtin.command: "openssl x509 -req -in {{ consul_temp_cert_dir }}/{{ item }}.csr -CA {{ consul_temp_cert_dir }}/ca.pem -CAkey {{ consul_temp_cert_dir }}/ca.key -CAcreateserial -out {{ consul_temp_cert_dir }}/{{ item }}.pem -days 365 -extfile {{ consul_temp_cert_dir }}/{{ item }}.cnf -extensions v3_req"
      args:
        creates: "{{ consul_temp_cert_dir }}/{{ item }}.pem"
      loop: "{{ groups['controller_nodes'] }}"

    # Client Certs
    - name: Generate OpenSSL config for client nodes
      ansible.builtin.copy:
        dest: "{{ consul_temp_cert_dir }}/{{ item }}.cnf"
        content: |
          [req]
          distinguished_name = req_distinguished_name
          req_extensions = v3_req
          prompt = no
          [req_distinguished_name]
          CN = client.consul
          [v3_req]
          keyUsage = keyEncipherment, dataEncipherment
          extendedKeyUsage = clientAuth, serverAuth
          subjectAltName = @alt_names
          [alt_names]
          DNS.1 = client.consul
          DNS.2 = localhost
          IP.1 = 127.0.0.1
          IP.2 = {{ hostvars[item]['cluster_ip'] }}
      loop: "{{ query('inventory_hostnames', 'all:!controller_nodes') }}"

    - name: Generate client keys for client nodes
      ansible.builtin.command: "openssl genrsa -out {{ consul_temp_cert_dir }}/{{ item }}.key 2048"
      args:
        creates: "{{ consul_temp_cert_dir }}/{{ item }}.key"
      loop: "{{ query('inventory_hostnames', 'all:!controller_nodes') }}"

    - name: Generate client CSRs for client nodes
      ansible.builtin.command: "openssl req -new -key {{ consul_temp_cert_dir }}/{{ item }}.key -out {{ consul_temp_cert_dir }}/{{ item }}.csr -config {{ consul_temp_cert_dir }}/{{ item }}.cnf"
      args:
        creates: "{{ consul_temp_cert_dir }}/{{ item }}.csr"
      loop: "{{ query('inventory_hostnames', 'all:!controller_nodes') }}"

    - name: Sign client certificates for client nodes
      ansible.builtin.command: "openssl x509 -req -in {{ consul_temp_cert_dir }}/{{ item }}.csr -CA {{ consul_temp_cert_dir }}/ca.pem -CAkey {{ consul_temp_cert_dir }}/ca.key -CAcreateserial -out {{ consul_temp_cert_dir }}/{{ item }}.pem -days 365 -extfile {{ consul_temp_cert_dir }}/{{ item }}.cnf -extensions v3_req"
      args:
        creates: "{{ consul_temp_cert_dir }}/{{ item }}.pem"
      loop: "{{ query('inventory_hostnames', 'all:!controller_nodes') }}"

  delegate_to: localhost
  run_once: true
  tags:
    - consul_configure

- name: Secure private keys on localhost
  ansible.builtin.shell: "chmod 0600 {{ consul_temp_cert_dir }}/*.key"
  delegate_to: localhost
  run_once: true
  tags:
    - consul_configure

- name: Set public certificates to readable on localhost
  ansible.builtin.shell: "chmod 0644 {{ consul_temp_cert_dir }}/*.pem {{ consul_temp_cert_dir }}/*.csr {{ consul_temp_cert_dir }}/*.cnf"
  delegate_to: localhost
  run_once: true
  tags:
    - consul_configure

# Task 10: Include TLS tasks (from original file)
- name: Include TLS tasks
  ansible.builtin.include_tasks: tls.yaml
  tags:
    - consul_configure

# Task 12: Copy Consul config (from original, with ownership/mode)
- name: Copy Consul config
  become: true
  ansible.builtin.template:
    src: consul.hcl.j2
    dest: "{{ consul_config_dir }}/consul.hcl"
    owner: consul
    group: consul
    mode: '0640'
  notify: Restart Consul
  tags:
    - consul_configure

# Task 13: Copy Consul systemd service file (from original file)
- name: Copy Consul systemd service file
  become: true
  ansible.builtin.template:
    src: consul.service.j2
    dest: /etc/systemd/system/consul.service
    mode: '0644'
  notify:
    - Reload systemd
    - Restart Consul
  tags:
    - consul_configure

- name: Create Consul log file
  become: true
  ansible.builtin.file:
    path: /var/log/consul.log
    state: touch
    owner: consul
    group: consul
    mode: '0640'
  tags:
    - consul_configure

- name: Validate Consul configuration
  become: true
  ansible.builtin.command: consul validate {{ consul_config_dir }}
  tags:
    - consul_configure

- name: Start and enable Consul service
  become: true
  ansible.builtin.systemd:
    name: consul
    state: started
    enabled: yes
  when: not ansible_check_mode
  tags:
    - consul_configure

- name: Allow Consul TCP ports in UFW
  ansible.builtin.command: ufw allow {{ item }}/tcp
  become: yes
  loop:
    - "{{ consul_http_port }}"
    - 8300
  changed_when: false
  ignore_errors: yes

- name: Allow Consul Mixed (TCP/UDP) ports in UFW
  ansible.builtin.command: ufw allow {{ item }}
  become: yes
  loop:
    - 8600
    - 8301
    - 8302
  changed_when: false
  ignore_errors: yes

- name: Flush handlers to ensure Consul is ready
  meta: flush_handlers

- name: Wait for Consul API to be ready
  block:
    - name: Wait for Consul API to be ready
      ansible.builtin.uri:
        url: "http://127.0.0.1:{{ consul_http_port }}/v1/status/leader"
        validate_certs: no
      register: consul_status
      until: consul_status.status == 200
      retries: 30
      delay: 5
  rescue:
    - name: Fetch Consul service logs (journald)
      ansible.builtin.shell: journalctl -u consul.service -n 50 --no-pager
      register: consul_journal_logs
      ignore_errors: true

    - name: Fetch Consul service logs (file)
      ansible.builtin.command: tail -n 50 /var/log/consul.log
      register: consul_file_logs
      ignore_errors: true

    - name: Display Consul service logs (journald)
      ansible.builtin.debug:
        var: consul_journal_logs.stdout_lines

    - name: Display Consul service logs (file)
      ansible.builtin.debug:
        var: consul_file_logs.stdout_lines

    - name: Fail task
      ansible.builtin.fail:
        msg: "Consul API failed to become ready. See logs above."
  when: not ansible_check_mode

- name: Wait for Consul to be ready before ACL bootstrap
  ansible.builtin.wait_for:
    host: "{{ advertise_ip }}"
    port: "{{ consul_http_port }}"
    delay: 10

- name: Include ACL tasks
  include_tasks: acl.yaml
