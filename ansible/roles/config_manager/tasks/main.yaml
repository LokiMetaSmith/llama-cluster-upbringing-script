- name: Wait for Home Assistant to generate auth file
  ansible.builtin.wait_for:
    path: /opt/nomad/volumes/ha-config/.storage/auth_provider.homeassistant
    timeout: 300
  become: yes

- name: Read and register Home Assistant token
  block:
    - name: Read Home Assistant auth file
      ansible.builtin.slurp:
        src: /opt/nomad/volumes/ha-config/.storage/auth_provider.homeassistant
      register: "hass_auth_file"
      become: yes

    - name: Set hass_token fact
      ansible.builtin.set_fact:
        hass_token: >
          {{
            (hass_auth_file['content'] | b64decode | from_json).data.ll_tokens
            | selectattr('type', 'eq', 'long_lived_access')
            | map(attribute='token')
            | first
          }}
    body: "{{ item.value | to_json }}"
    status_code: 200

- name: Populate Consul KV with Model Configurations
  ansible.builtin.uri:
    url: "http://127.0.0.1:8500/v1/kv/config/models/{{ item.key }}"
    method: PUT
  loop: >
    {{
      (expert_models | dict2items) +
      [
        { 'key': 'tts_voices', 'value': tts_voices },
        { 'key': 'piper_voice_files', 'value': piper_voice_files },
        { 'key': 'embedding_models', 'value': embedding_models },
        { 'key': 'stt_models', 'value': stt_models },
        { 'key': 'vision_models', 'value': vision_models }
      ]
    }}
  loop_control:
    label: "{{ item.key }}"

- name: Populate Consul KV with Home Assistant Token
  ansible.builtin.uri:
    url: "http://127.0.0.1:8500/v1/kv/config/hass/token"
    method: PUT
    body: "{{ hass_token }}"
    status_code: 200
  when: hass_token is defined

- name: Populate Consul KV with App Settings
  ansible.builtin.uri:
    url: "http://127.0.0.1:8500/v1/kv/config/app/settings"
    method: PUT
    body: >
      {{
        {
          "llama_api_service_name": llama_api_service_name,
          "use_summarizer": use_summarizer,
          "stt_service": stt_service,
          "pipecat_app_dir": pipecat_app_dir,
          "pipecat_log_file": pipecat_log_file,
          "active_stt_provider": active_stt_provider,
          "active_stt_model_name": active_stt_model_name,
          "pipecat_api_keys": pipecat_api_keys,
          "external_experts_config": external_experts_config,
          "openai_api_key": openai_api_key,
          "advertise_ip": advertise_ip,
          "nomad_models_dir": nomad_models_dir,
          "expected_cluster_size": expected_cluster_size,
          "ha_url": "{{ ha_url | default('') }}",
          "ha_token": "{{ hass_token | default('') }}"
        } | to_json
      }}
    status_code: 200
