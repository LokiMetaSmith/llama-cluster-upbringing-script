# Config generated by Ansible
data_dir  = "{{ nomad_data_dir }}"
bind_addr = "{{ cluster_ip }}"

addresses {
  http = "{{ cluster_ip }}"
  rpc  = "{{ cluster_ip }}"
  serf = "{{ cluster_ip }}"
}

advertise {
  # Advertise the private IP so other nodes talk over the private lane
  http = "{{ advertise_ip }}"
  rpc  = "{{ cluster_ip }}"
  serf = "{{ cluster_ip }}"
}

{% if is_controller is defined and is_controller %}
server {
  enabled = true
  bootstrap_expect = {{ nomad_bootstrap_expect }}
}
{% endif %}

consul {
  address = "{{ cluster_ip }}:{{ consul_http_port }}"
  {% if consul_bootstrap_token is defined %}
  token   = "{{ consul_bootstrap_token }}"
  {% endif %}
}

plugin "docker" {
  config {
    endpoint = "unix:///var/run/docker.sock"
    volumes {
      enabled = true
    }
    allow_caps = ["NET_RAW", "NET_ADMIN", "SETUID", "SETGID", "CHOWN", "NET_BIND_SERVICE"]
  }
}

plugin "raw_exec" {
  config {
    enabled = true
  }
}

client {
  enabled = true
  servers = ["{{ cluster_ip }}"]

  meta {
    node_type = "controller"
  }

  host_volume "pipecatapp" {
    path      = "{{ pipecat_app_dir }}"
    read_only = false
  }

  # The "snd" volume is required for voice applications but will prevent
  # Nomad from starting on machines without a sound device. It is commented
  # out to allow for more flexible deployment. The pipecat job itself will
  # still require this volume to be present on the target node.
  {% if snd_device_stat.stat.exists %}
  host_volume "snd" {
    path      = "/dev/snd"
    read_only = false
  }
  {% endif %}

  host_volume "models" {
    path      = "{{ nomad_models_dir }}"
    read_only = true
  }

  host_volume "mqtt-data" {
    path      = "{{ nomad_volumes_dir }}/mqtt-data"
    read_only = false
  }

  host_volume "ha-config" {
    path      = "{{ nomad_volumes_dir }}/ha-config"
    read_only = false
  }

  host_volume "world_model_storage" {
    path      = "{{ nomad_volumes_dir }}/world_model_storage"
    read_only = false
  }

  host_volume "memory-data" {
    path      = "{{ nomad_volumes_dir }}/memory-data"
    read_only = false
  }

}
