- name: "World Model Service : Ensure world_model_service directories exist"
  tags:
    - world_model_service
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: "{{ target_user }}"
    group: "{{ target_user }}"
    mode: "0755"
  loop:
    - "/opt/world_model_service"
    - "/opt/world_model_service/config"
    - "/opt/nomad/volumes/world_model_storage"
  become: true

- name: "World Model Service : Copy service files"
  tags:
    - world_model_service
  ansible.builtin.copy:
    src: "{{ item }}"
    dest: "/opt/world_model_service/"
    owner: "{{ target_user }}"
    group: "{{ target_user }}"
    mode: "0644"
  loop:
    - "app.py"
    - "requirements.txt"
    - "Dockerfile"
  become: true

- name: "World Model Service : Build the docker image"
  tags:
    - world_model_service
  ansible.builtin.command:
    cmd: "docker build --no-cache -t world-model-service:local ."
    chdir: "/opt/world_model_service/"
  register: docker_build_result
  changed_when: "'Successfully built' in docker_build_result.stdout or 'writing image' in docker_build_result.stdout"
  become: true

- name: "World Model Service : Copy debug script"
  tags:
    - world_model_service
  ansible.builtin.copy:
    src: "debug_world_model.sh"
    dest: "/opt/world_model_service/debug_world_model.sh"
    owner: "{{ target_user }}"
    group: "{{ target_user }}"
    mode: "0755"
  become: true

- name: "World Model Service : Run debug script (verify container)"
  tags:
    - world_model_service
  ansible.builtin.command:
    cmd: "/opt/world_model_service/debug_world_model.sh"
  environment:
    DEBUG_KEEP_ALIVE: "{{ 'true' if watch_target is defined and (watch_target in ansible_role_name or watch_target in 'World Model Service : Run debug script (verify container)') else 'false' }}"
  become: true
  register: debug_output
  changed_when: false
  failed_when: false

- name: "World Model Service : Pause for inspection"
  tags:
    - world_model_service
  ansible.builtin.pause:
    prompt: "Paused for inspection of {{ ansible_role_name }}. [s]tep to continue, [r]un to disable waiting"
  register: pause_result
  when:
    - watch_target is defined
    - watch_target in ansible_role_name or watch_target in 'World Model Service : Run debug script (verify container)'

- name: "World Model Service : Disable Watch Mode"
  tags:
    - world_model_service
  ansible.builtin.set_fact:
    watch_target: ""
  when:
    - pause_result.user_input is defined
    - pause_result.user_input | trim == 'r'

- name: "World Model Service : Cleanup debug container"
  tags:
    - world_model_service
  ansible.builtin.command:
    cmd: "docker rm -f world-model-debug world-model-debug-mqtt"
  become: true
  when:
    - watch_target is defined
  failed_when: false
  changed_when: true

- name: "World Model Service : Display debug output"
  tags:
    - world_model_service
  ansible.builtin.debug:
    var: debug_output.stdout_lines

- name: "World Model Service : Deploy world_model.nomad job"
  tags:
    - world_model_service
  ansible.builtin.template:
    src: "world_model.nomad.j2"
    dest: "{{ nomad_jobs_dir }}/world_model.nomad"
    owner: "root"
    group: "root"
    mode: "0644"
  become: true
  register: nomad_job_template

- name: "World Model Service : Deploy World Model Job"
  tags:
    - world_model_service
  block:
    - name: "World Model Service : Purge existing nomad job (force image update)"
      ansible.builtin.command:
        cmd: "nomad job stop -purge world-model-service"
      ignore_errors: yes
      changed_when: true
      become: no

    - name: "World Model Service : Run nomad job"
      ansible.builtin.command:
        cmd: "nomad job run {{ nomad_jobs_dir }}/world_model.nomad"
      changed_when: true
      become: no
      register: world_model_job_run

  rescue:
    - name: "World Model Service : Get World Model job status"
      ansible.builtin.command:
        cmd: nomad job status -verbose world-model-service
      register: wm_job_status
      ignore_errors: yes
      become: no

    - name: "World Model Service : Display World Model job status"
      ansible.builtin.debug:
        var: wm_job_status.stdout

    - name: "World Model Service : Get World Model allocations"
      ansible.builtin.command:
        cmd: /usr/local/bin/nomad job allocs -json world-model-service
      register: wm_allocs
      ignore_errors: yes
      become: no

    - name: "World Model Service : Save World Model allocations to temp file"
      ansible.builtin.copy:
        content: "{{ wm_allocs.stdout }}"
        dest: "/tmp/wm_allocs.json"

    - name: "World Model Service : Extract Allocation ID"
      ansible.builtin.command: jq -r 'sort_by(.CreateTime) | reverse | .[0].ID' /tmp/wm_allocs.json
      register: wm_alloc_id
      ignore_errors: yes

    - name: "World Model Service : Fetch World Model logs (stdout)"
      ansible.builtin.command:
        cmd: "/usr/local/bin/nomad alloc logs {{ wm_alloc_id.stdout }}"
      register: wm_logs_stdout
      ignore_errors: yes
      become: no
      when: wm_alloc_id.stdout | length > 0

    - name: "World Model Service : Display World Model logs (stdout)"
      ansible.builtin.debug:
        var: wm_logs_stdout.stdout
      when: wm_logs_stdout is defined

    - name: "World Model Service : Fetch World Model logs (stderr)"
      ansible.builtin.command:
        cmd: "/usr/local/bin/nomad alloc logs -stderr {{ wm_alloc_id.stdout }}"
      register: wm_logs_stderr
      ignore_errors: yes
      become: no
      when: wm_alloc_id.stdout | length > 0

    - name: "World Model Service : Display World Model logs (stderr)"
      ansible.builtin.debug:
        var: wm_logs_stderr.stdout
      when: wm_logs_stderr is defined

    - name: "World Model Service : Clean up temp file"
      ansible.builtin.file:
        path: "/tmp/wm_allocs.json"
        state: absent

    - name: "World Model Service : Fail after debugging"
      ansible.builtin.fail:
        msg: "World Model job failed to start. See logs above."

- name: "World Model Service : Deploy llamacpp-batch.nomad job"
  tags:
    - world_model_service
  ansible.builtin.template:
    src: "../../jobs/llamacpp-batch.nomad.j2"
    dest: "{{ nomad_jobs_dir }}/llamacpp-batch.nomad"
    owner: "root"
    group: "root"
    mode: "0644"
  become: true
  register: batch_job_template

- name: "World Model Service : Register batch nomad job"
  ansible.builtin.command:
    cmd: "/usr/local/bin/nomad job run {{ nomad_jobs_dir }}/llamacpp-batch.nomad"
  #environment:
    #NOMAD_ADDR: "http://{{ cluster_ip }}:4646"
    #NOMAD_ADDR: "http://127.0.0.1:4646"
  changed_when: true
  become: no
