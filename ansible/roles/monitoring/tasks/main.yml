- name: Ensure Grafana dashboard directory exists
  ansible.builtin.file:
    path: "{{ nomad_volumes_dir }}/grafana/dashboards"
    state: directory
    mode: '0755'
    recurse: yes
  become: yes

- name: Download Node Exporter Full Dashboard
  ansible.builtin.command:
    cmd: curl -L -o "{{ nomad_volumes_dir }}/grafana/dashboards/node-exporter-full.json" https://grafana.com/api/dashboards/1860/revisions/37/download
    creates: "{{ nomad_volumes_dir }}/grafana/dashboards/node-exporter-full.json"
  become: yes

- name: Download Nomad Dashboard
  ansible.builtin.command:
    cmd: curl -L -o "{{ nomad_volumes_dir }}/grafana/dashboards/nomad.json" https://grafana.com/api/dashboards/19154/revisions/1/download
    creates: "{{ nomad_volumes_dir }}/grafana/dashboards/nomad.json"
  become: yes

# Consul Dashboard (ID 13627 is for Native Metrics)
- name: Download Consul Dashboard
  ansible.builtin.command:
    cmd: curl -L -o "{{ nomad_volumes_dir }}/grafana/dashboards/consul.json" https://grafana.com/api/dashboards/13627/revisions/1/download
    creates: "{{ nomad_volumes_dir }}/grafana/dashboards/consul.json"
  become: yes

# MQTT Dashboard (Using a generic MQTT dashboard as a base, e.g., ID 11288)
- name: Download MQTT Dashboard
  ansible.builtin.command:
    cmd: curl -L -o "{{ nomad_volumes_dir }}/grafana/dashboards/mqtt.json" https://grafana.com/api/dashboards/11288/revisions/1/download
    creates: "{{ nomad_volumes_dir }}/grafana/dashboards/mqtt.json"
  become: yes

- name: Copy LLM Performance Dashboard
  ansible.builtin.copy:
    src: llm_dashboard.json
    dest: "{{ nomad_volumes_dir }}/grafana/dashboards/llm_dashboard.json"
    mode: '0644'
  become: yes

- name: Deploy Node Exporter
  block:
    - name: Template node-exporter job
      ansible.builtin.template:
        src: node-exporter.nomad.j2
        dest: "{{ nomad_jobs_dir }}/node-exporter.nomad"
      become: yes

    - name: Run node-exporter job
      ansible.builtin.command:
        cmd: /usr/local/bin/nomad job run -detach {{ nomad_jobs_dir }}/node-exporter.nomad
      environment:
        NOMAD_ADDR: "http://{{ cluster_ip }}:{{ nomad_http_port }}"
      changed_when: true

- name: Deploy Memory Audit
  block:
    - name: Template memory-audit job
      ansible.builtin.template:
        src: memory-audit.nomad.j2
        dest: "{{ nomad_jobs_dir }}/memory-audit.nomad"
      become: yes

    - name: Run memory-audit job
      ansible.builtin.command:
        cmd: /usr/local/bin/nomad job run -detach {{ nomad_jobs_dir }}/memory-audit.nomad
      environment:
        NOMAD_ADDR: "http://{{ cluster_ip }}:{{ nomad_http_port }}"
      changed_when: true
  rescue:
    - name: Get MQTT Exporter job status
      ansible.builtin.command:
        cmd: /usr/local/bin/nomad job status -verbose mqtt-exporter
      environment:
        NOMAD_ADDR: "http://{{ cluster_ip }}:{{ nomad_http_port }}"
      register: mqtt_exporter_job_status
      ignore_errors: yes

    - name: Display MQTT Exporter job status
      ansible.builtin.debug:
        var: mqtt_exporter_job_status.stdout

    - name: Get MQTT Exporter allocations
      ansible.builtin.command:
        cmd: /usr/local/bin/nomad job allocs -json mqtt-exporter
      environment:
        NOMAD_ADDR: "http://{{ cluster_ip }}:{{ nomad_http_port }}"
      register: mqtt_exporter_allocs
      ignore_errors: yes

    - name: Save MQTT Exporter allocations to temp file
      ansible.builtin.copy:
        content: "{{ mqtt_exporter_allocs.stdout }}"
        dest: "/tmp/mqtt_exporter_allocs.json"

    - name: Extract Allocation ID
      ansible.builtin.command: jq -r 'sort_by(.CreateTime) | reverse | .[0].ID' /tmp/mqtt_exporter_allocs.json
      register: mqtt_exporter_alloc_id
      ignore_errors: yes

    - name: Fetch MQTT Exporter logs (stdout)
      ansible.builtin.command:
        cmd: "/usr/local/bin/nomad alloc logs {{ mqtt_exporter_alloc_id.stdout }}"
      environment:
        NOMAD_ADDR: "http://{{ cluster_ip }}:{{ nomad_http_port }}"
      register: mqtt_exporter_logs_stdout
      ignore_errors: yes
      when: (mqtt_exporter_alloc_id.stdout | trim | length > 0) and (mqtt_exporter_alloc_id.stdout | trim != 'null')

    - name: Display MQTT Exporter logs (stdout)
      ansible.builtin.debug:
        var: mqtt_exporter_logs_stdout.stdout
      when: mqtt_exporter_logs_stdout.stdout is defined

    - name: Fetch MQTT Exporter logs (stderr)
      ansible.builtin.command:
        cmd: "/usr/local/bin/nomad alloc logs -stderr {{ mqtt_exporter_alloc_id.stdout }}"
      environment:
        NOMAD_ADDR: "http://{{ cluster_ip }}:{{ nomad_http_port }}"
      register: mqtt_exporter_logs_stderr
      ignore_errors: yes
      when: (mqtt_exporter_alloc_id.stdout | trim | length > 0) and (mqtt_exporter_alloc_id.stdout | trim != 'null')

    - name: Display MQTT Exporter logs (stderr)
      ansible.builtin.debug:
        var: mqtt_exporter_logs_stderr.stdout
      when: mqtt_exporter_logs_stderr.stdout is defined

    - name: Clean up temp file
      ansible.builtin.file:
        path: "/tmp/mqtt_exporter_allocs.json"
        state: absent

    - name: Fail after debugging
      ansible.builtin.fail:
        msg: "MQTT Exporter job failed to start. See logs above."

- name: Deploy MQTT Exporter
  block:
    - name: Wait for MQTT service to be ready
      ansible.builtin.wait_for:
        host: "{{ cluster_ip }}"
        port: "{{ mqtt_port }}"
        timeout: 300
        state: started

    - name: Template mqtt-exporter job
      ansible.builtin.template:
        src: mqtt-exporter.nomad.j2
        dest: "{{ nomad_jobs_dir }}/mqtt-exporter.nomad"
      become: yes

    - name: Run mqtt-exporter job
      ansible.builtin.command:
        cmd: /usr/local/bin/nomad job run -detach {{ nomad_jobs_dir }}/mqtt-exporter.nomad
      environment:
        NOMAD_ADDR: "http://{{ cluster_ip }}:{{ nomad_http_port }}"
      changed_when: true

- name: Deploy Prometheus
  block:
    - name: Template prometheus job
      ansible.builtin.template:
        src: prometheus.nomad.j2
        dest: "{{ nomad_jobs_dir }}/prometheus.nomad"
      become: yes

    - name: Run prometheus job
      ansible.builtin.command:
        cmd: /usr/local/bin/nomad job run -detach {{ nomad_jobs_dir }}/prometheus.nomad
      environment:
        NOMAD_ADDR: "http://{{ cluster_ip }}:{{ nomad_http_port }}"
      changed_when: true

- name: Deploy Grafana
  block:
    - name: Template grafana job
      ansible.builtin.template:
        src: grafana.nomad.j2
        dest: "{{ nomad_jobs_dir }}/grafana.nomad"
      become: yes

    - name: Run grafana job
      ansible.builtin.command:
        cmd: /usr/local/bin/nomad job run -detach {{ nomad_jobs_dir }}/grafana.nomad
      environment:
        NOMAD_ADDR: "http://{{ cluster_ip }}:{{ nomad_http_port }}"
      changed_when: true
