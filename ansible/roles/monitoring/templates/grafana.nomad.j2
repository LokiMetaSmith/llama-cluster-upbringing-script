job "grafana" {
  datacenters = ["dc1"]
  type        = "service"

  # Update stanza for reliability
  update {
    max_parallel      = 1
    health_check      = "checks"
    min_healthy_time  = "10s"
    healthy_deadline  = "15m"
    progress_deadline = "20m"
    auto_revert       = true
    canary            = 0
  }

  group "grafana" {
    count = 1

    # Ensure Grafana runs on the node where dashboards are provisioned
    # We use a unique constraint on the hostname matching the actual system hostname (controller node)
    # inventory_hostname often resolves to 'localhost' in local execution, which Nomad rejects
    constraint {
      attribute = "${attr.unique.hostname}"
      value     = "{{ lookup('pipe', 'hostname') }}"
    }

    network {
      mode = "host"
      port "http" {
        static = {{ grafana_port }}
      }
    }

    task "grafana" {
      driver = "docker"

      config {
        image = "grafana/grafana:{{ grafana_version }}"

        # Mount the dashboard directory from the host directly
        # This avoids the circular dependency of needing a host_volume defined in client.hcl (which requires directory existence + restart)
        mounts = [
          {
            type     = "bind"
            target   = "/local/dashboards"
            source   = "{{ nomad_volumes_dir }}/grafana/dashboards"
            readonly = true
          }
        ]
      }

      env {
        GF_SECURITY_ADMIN_PASSWORD = "{{ grafana_admin_password | default('admin') }}"
        GF_USERS_ALLOW_SIGN_UP = "false"
        # Provisioning paths
        GF_PATHS_PROVISIONING = "/local/provisioning"
      }

      template {
        data = <<EOF
{{ lookup('template', 'datasource.yaml.j2') }}
EOF
        destination = "local/provisioning/datasources/datasource.yaml"
      }

      template {
        data = <<EOF
{{ lookup('template', 'dashboards.yaml.j2') }}
EOF
        destination = "local/provisioning/dashboards/dashboards.yaml"
      }

      resources {
        cpu    = 200
        memory = 256
      }

      service {
        name = "grafana"
        port = "http"
        tags = ["urlprefix-/"]

        check {
          type     = "http"
          path     = "/api/health"
          interval = "10s"
          timeout  = "2s"
        }
      }
    }

  }
}
