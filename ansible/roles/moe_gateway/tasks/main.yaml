- name: Ensure gateway application directory exists
  ansible.builtin.file:
    path: "{{ pipecat_app_dir }}/moe_gateway"
    state: directory
    owner: root
    group: root
    mode: "0755"

- name: Copy gateway application file
  ansible.builtin.copy:
    src: gateway.py
    dest: "{{ pipecat_app_dir }}/moe_gateway/gateway.py"
    owner: root
    group: root
    mode: "0755"

- name: Copy gateway static files
  ansible.builtin.copy:
    src: static/
    dest: "{{ pipecat_app_dir }}/moe_gateway/static/"
    owner: root
    group: root
    mode: "0755"

- name: Create moe-gateway job file
  ansible.builtin.template:
    src: moe-gateway.nomad.j2
    dest: "{{ nomad_jobs_dir }}/moe-gateway.nomad"
    owner: root
    group: root
    mode: "0644"
  notify:
    - Run moe-gateway job

- name: Debug Nomad Address
  ansible.builtin.debug:
    msg: "NOMAD_ADDR is http://{{ cluster_ip }}:{{ nomad_http_port }}"

- name: Wait for Nomad API to be ready
  ansible.builtin.uri:
    url: "http://{{ cluster_ip }}:{{ nomad_http_port }}/v1/status/leader"
    method: GET
    status_code: 200
  register: nomad_api_status
  until: nomad_api_status.status == 200
  retries: 12 # Total wait time = retries * delay = 60 seconds
  delay: 5   # Wait 5 seconds between retries

- name: Stop and purge any existing moe-gateway job to ensure idempotency
  ansible.builtin.command:
    cmd: /usr/local/bin/nomad job stop -purge moe-gateway
  register: moe_gateway_job_stop_status
  changed_when: "moe_gateway_job_stop_status.rc == 0"
  failed_when: false
  environment:
    NOMAD_ADDR: "http://{{ cluster_ip }}:{{ nomad_http_port }}"

- name: Deploy moe-gateway Job
  block:
    - name: Ensure moe-gateway job is running
      ansible.builtin.command:
        cmd: "/usr/local/bin/nomad job run {{ nomad_jobs_dir }}/moe-gateway.nomad"
      environment:
        NOMAD_ADDR: "http://{{ cluster_ip }}:{{ nomad_http_port }}"
      changed_when: true
      become: no
      register: moe_gateway_job_run
  rescue:
    - name: Get moe-gateway job status
      ansible.builtin.command:
        cmd: /usr/local/bin/nomad job status -verbose moe-gateway
      environment:
        NOMAD_ADDR: "http://{{ cluster_ip }}:{{ nomad_http_port }}"
      register: moe_job_status
      ignore_errors: yes
      become: no

    - name: Display moe-gateway job status
      ansible.builtin.debug:
        var: moe_job_status.stdout

    - name: Get moe-gateway allocations
      ansible.builtin.command:
        cmd: /usr/local/bin/nomad job allocs -json moe-gateway
      environment:
        NOMAD_ADDR: "http://{{ cluster_ip }}:{{ nomad_http_port }}"
      register: moe_allocs
      ignore_errors: yes
      become: no

    - name: Save moe-gateway allocations to temp file
      ansible.builtin.copy:
        content: "{{ moe_allocs.stdout }}"
        dest: "/tmp/moe_allocs.json"

    - name: Extract Allocation ID
      ansible.builtin.command: jq -r 'sort_by(.CreateTime) | reverse | .[0].ID' /tmp/moe_allocs.json
      register: moe_alloc_id
      ignore_errors: yes

    - name: Fetch moe-gateway logs (stdout)
      ansible.builtin.command:
        cmd: "/usr/local/bin/nomad alloc logs {{ moe_alloc_id.stdout }}"
      environment:
        NOMAD_ADDR: "http://{{ cluster_ip }}:{{ nomad_http_port }}"
      register: moe_logs_stdout
      ignore_errors: yes
      become: no
      when: moe_alloc_id.stdout | length > 0

    - name: Display moe-gateway logs (stdout)
      ansible.builtin.debug:
        var: moe_logs_stdout.stdout
      when: moe_logs_stdout is defined

    - name: Fetch moe-gateway logs (stderr)
      ansible.builtin.command:
        cmd: "/usr/local/bin/nomad alloc logs -stderr {{ moe_alloc_id.stdout }}"
      environment:
        NOMAD_ADDR: "http://{{ cluster_ip }}:{{ nomad_http_port }}"
      register: moe_logs_stderr
      ignore_errors: yes
      become: no
      when: moe_alloc_id.stdout | length > 0

    - name: Display moe-gateway logs (stderr)
      ansible.builtin.debug:
        var: moe_logs_stderr.stdout
      when: moe_logs_stderr is defined

    - name: Clean up temp file
      ansible.builtin.file:
        path: "/tmp/moe_allocs.json"
        state: absent

    - name: Fail after debugging
      ansible.builtin.fail:
        msg: "moe-gateway job failed to start. See logs above."
