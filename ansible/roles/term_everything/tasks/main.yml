- name: Install podman
  become: yes
  ansible.builtin.apt:
    name: podman
    state: present
    update_cache: yes

- name: Clone term.everything repository
  ansible.builtin.git:
    repo: "https://github.com/mmulet/term.everything.git"
    dest: "/tmp/term.everything"
    version: "main"
    recursive: yes

- name: Build term.everything AppImage
  become: yes
  block:
    - name: Attempt to build term.everything AppImage
      ansible.builtin.command:
        cmd: ./distribute.sh
        chdir: /tmp/term.everything
      register: build_result
      changed_when: build_result.rc == 0
      failed_when: build_result.rc != 0
  rescue:
    - name: "Debug: Display build stdout"
      ansible.builtin.debug:
        var: build_result.stdout
      when: build_result.stdout is defined and build_result.stdout != ""

    - name: "Debug: Display build stderr"
      ansible.builtin.debug:
        var: build_result.stderr
      when: build_result.stderr is defined and build_result.stderr != ""

    - name: Fail the playbook with a clear error message
      ansible.builtin.fail:
        msg: "Failed to build term.everything AppImage. See stdout/stderr for details."

- name: Create tools directory
  ansible.builtin.file:
    path: /opt/mcp/tools
    state: directory
    mode: "0755"
  become: yes

- name: Find the AppImage file
  ansible.builtin.find:
    paths: /tmp/term.everything/dist
    patterns: "*.AppImage"
  register: find_result

- name: Move AppImage to tools directory
  ansible.builtin.copy:
    src: "{{ item.path }}"
    dest: "/opt/mcp/tools/termeverything.AppImage"
    remote_src: yes
    mode: "0755"
  loop: "{{ find_result.files }}"
  when: find_result.files | length > 0
  become: yes

- name: Clean up temporary build directory
  ansible.builtin.file:
    path: /tmp/term.everything
    state: absent
  become: yes
