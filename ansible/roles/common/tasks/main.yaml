---
- name: Update apt cache
  apt:
    update_cache: yes
    cache_valid_time: 3600

- name: Upgrade all packages to the latest version
  apt:
    upgrade: dist

- name: Install common packages
  apt:
    name:
      - openssh-server
      - chrony
      - git
      - cmake
      - curl
      - python3-full
      - python3-pip
      - libcurl4-openssl-dev
    state: present

- name: Prefer IPv4 over IPv6 for outbound connections
  lineinfile:
    path: /etc/gai.conf
    regexp: '^#precedence ::ffff:0:0/96  100'
    line: 'precedence ::ffff:0:0/96  100'
    backrefs: yes
  when: ansible_host != '127.0.0.1'

- name: Manage /etc/hosts file on controller for name resolution
  template:
    src: hosts.j2
    dest: /etc/hosts
  when: ansible_host == '127.0.0.1'

- name: Find the default gateway interface
  shell: "ip route | grep default | awk '{print $5}'"
  register: default_gw_interface
  changed_when: false
  check_mode: no
  when: ansible_host != '127.0.0.1'

- name: Disable any non-gateway interfaces that have an IP
  community.general.nmcli:
    conn: "{{ item.device }}"
    state: disconnected
  loop: "{{ ansible_interfaces }}"
  when:
    - ansible_host != '127.0.0.1'
    - item.ipv4 is defined
    - item.device != default_gw_interface.stdout
    - item.device != 'lo'
