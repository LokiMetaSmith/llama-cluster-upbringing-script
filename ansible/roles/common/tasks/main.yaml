- name: Include Network Repair Tasks
  include_tasks: network_repair.yaml
  tags: [network]

- name: Kill any existing apt processes
  shell: "killall apt apt-get || true"
  become: yes
  changed_when: false

- name: Remove apt lock files
  file:
    path: "{{ item }}"
    state: absent
  loop:
    - /var/lib/dpkg/lock
    - /var/lib/dpkg/lock-frontend
    - /var/lib/apt/lists/lock
    - /var/cache/apt/archives/lock
  become: yes

- name: Update apt cache
  apt:
    update_cache: yes
    cache_valid_time: 3600

- name: Upgrade all packages to the latest version
  apt:
    upgrade: dist

- name: Install common packages
  apt:
    name:
      - openssh-server
      - chrony
      - git
      - cmake
      - curl
      - python3-full
      - python3-pip
      - libcurl4-openssl-dev
      - rsync
    state: present

- name: Manage /etc/hosts file on controller for name resolution
  template:
    src: hosts.j2
    dest: /etc/hosts
  when: ansible_host == '127.0.0.1'

- name: Find the default gateway interface
  shell: "ip route | grep default | awk '{print $5}' | head -n1"
  register: default_gw_interface
  changed_when: false
  check_mode: no

- name: Deploy Cluster IP alias service
  template:
    src: cluster-ip-alias.service.j2
    dest: /etc/systemd/system/cluster-ip-alias.service
    mode: '0644'
  notify: restart cluster-ip-alias
  become: yes

- name: Ensure Cluster IP alias service is enabled and started
  systemd:
    name: cluster-ip-alias
    state: started
    enabled: yes
    daemon_reload: yes
  become: yes

- name: Prevent system sleep but allow screen blanking
  lineinfile:
    path: /etc/systemd/logind.conf
    regexp: '^#?IdleAction=.*'
    line: 'IdleAction=lock'
  notify: restart systemd-logind

- name: Create parent directory for all models
  ansible.builtin.file:
    path: "{{ nomad_models_dir }}"
    state: directory
    mode: '0755'
  become: yes

- name: Create unified model directory structure
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: '0755'
  loop:
    - "{{ nomad_models_dir }}/llm"
    - "{{ nomad_models_dir }}/stt"
    - "{{ nomad_models_dir }}/tts"
    - "{{ nomad_models_dir }}/embedding"
    - "{{ nomad_models_dir }}/vision"
  become: yes

- name: Deploy SSH authorized keys sync script
  ansible.builtin.template:
    src: update-ssh-authorized-keys.sh.j2
    dest: /usr/local/bin/update-ssh-authorized-keys.sh
    mode: '0755'
  register: sync_script

- name: Perform initial SSH key sync
  ansible.builtin.command:
    cmd: /usr/local/bin/update-ssh-authorized-keys.sh
  when: sync_script.changed

- name: Disable password authentication for SSH
  lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^#?PasswordAuthentication'
    line: 'PasswordAuthentication no'
    state: present
  notify: restart ssh
  become: yes

# --- Firewall Configuration ---

- name: "Firewall : Allow SSH"
  community.general.ufw:
    rule: allow
    name: OpenSSH
    comment: "Allow SSH access from anywhere"

- name: "Firewall : Allow all Loopback traffic"
  community.general.ufw:
    rule: allow
    interface: lo
    direction: in
    comment: "Allow all loopback traffic (critical for local health checks)"

- name: "Firewall : Allow all Cluster Internal Traffic"
  community.general.ufw:
    rule: allow
    from_ip: "10.0.0.0/24"
    comment: "Allow full communication between cluster nodes on the private network"

- name: "Firewall : Allow Nomad/Consul UIs from Home Network"
  community.general.ufw:
    rule: allow
    port: "{{ item }}"
    proto: tcp
    comment: "Allow Management UIs"
  loop:
    - "{{ nomad_http_port }}" # Nomad HTTP
    - "{{ consul_http_port }}" # Consul HTTP

- name: "Firewall : Allow MQTT/Application Ports"
  community.general.ufw:
    rule: allow
    port: "{{ item }}"
    proto: tcp
    comment: "Allow App Services"
  loop:
    - "{{ mqtt_port }}" # MQTT
    - "{{ mqtt_websocket_port }}" # MQTT Websockets
    - "{{ router_port }}" # Traefik / Router (if used)
    - "{{ archivist_port }}" # Archivist Service

- name: "Firewall : Allow Exo Port"
  community.general.ufw:
    rule: allow
    port: "{{ exo_port }}"
    proto: tcp
    comment: "Allow Exo P2P/API"
  when: exo_enable | default(false)
- name: "Firewall : Allow Provisioning API"
  community.general.ufw:
    rule: allow
    port: "{{ provisioning_api_port }}"
    proto: tcp
    comment: "Allow Provisioning API"
  when: enable_provisioning_api | default(true)

- name: "Firewall : Allow Home Assistant"
  community.general.ufw:
    rule: allow
    port: "{{ home_assistant_port }}"
    proto: tcp
    comment: "Allow Home Assistant UI"
  when: enable_home_assistant | default(true)

- name: "Firewall : Allow Nanochat"
  community.general.ufw:
    rule: allow
    port: "{{ nanochat_port }}"
    proto: tcp
    comment: "Allow Nanochat UI"
  when: enable_nanochat | default(false)

- name: "Firewall : Allow Frigate (Vision)"
  community.general.ufw:
    rule: allow
    port: "{{ frigate_port }}"
    proto: tcp
    comment: "Allow Frigate UI"
  when: enable_frigate | default(false)

- name: "Firewall : Allow Web Traffic (HTTP/HTTPS)"
  community.general.ufw:
    rule: allow
    port: "{{ item }}"
    proto: tcp
    comment: "Allow Standard Web Traffic"
  loop:
    - 80
    - 443

- name: "Firewall : Allow Nomad Ephemeral Ports"
  community.general.ufw:
    rule: allow
    port: "20000:32000"
    proto: tcp
    comment: "Allow Nomad ephemeral ports for dynamic allocations"

- name: "Firewall : Enable UFW"
  community.general.ufw:
    state: enabled
    policy: deny
    logging: low
