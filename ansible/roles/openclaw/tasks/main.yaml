- name: Create OpenClaw directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: '0755'
    owner: "{{ target_user | default('root') }}"
    group: "{{ target_user | default('root') }}"
  loop:
    - /opt/openclaw
    - /opt/openclaw/config
    - /opt/openclaw/data
    - /opt/openclaw/skills/pipecat
    - /opt/openclaw/docker

- name: Copy OpenClaw Dockerfile
  ansible.builtin.copy:
    src: Dockerfile
    dest: /opt/openclaw/docker/Dockerfile
    mode: '0644'
    owner: "{{ target_user | default('root') }}"
    group: "{{ target_user | default('root') }}"

- name: Build OpenClaw Docker image
  community.docker.docker_image:
    name: openclaw
    tag: latest
    source: build
    build:
      path: /opt/openclaw/docker
      pull: true
    force_source: true

- name: Check if local registry is reachable
  ansible.builtin.wait_for:
    host: "{{ docker_registry_host }}"
    port: "{{ docker_registry_port }}"
    state: started
    timeout: 1
  register: registry_check
  ignore_errors: true

- name: Tag and push openclaw image to local registry
  community.docker.docker_image:
    name: openclaw
    tag: latest
    repository: "{{ docker_registry_host }}:{{ docker_registry_port }}/openclaw"
    push: true
    source: local
  when: registry_check is success

- name: Copy Pipecat Skill
  ansible.builtin.copy:
    src: pipecat_skill.md
    dest: /opt/openclaw/skills/pipecat/SKILL.md
    mode: '0644'
    owner: "{{ target_user | default('root') }}"
    group: "{{ target_user | default('root') }}"

- name: Template OpenClaw Nomad job file
  ansible.builtin.template:
    src: openclaw.nomad.j2
    dest: "{{ nomad_jobs_dir | default('/opt/nomad/jobs') }}/openclaw.nomad"
    mode: '0644'

- name: Run OpenClaw Nomad job
  ansible.builtin.command:
    cmd: "/usr/local/bin/nomad job run -detach {{ nomad_jobs_dir | default('/opt/nomad/jobs') }}/openclaw.nomad"
  environment:
    NOMAD_ADDR: "http://{{ cluster_ip | default('localhost') }}:4646"
  register: openclaw_job_run
  changed_when: true
