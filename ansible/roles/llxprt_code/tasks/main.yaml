- name: Install dependencies for NodeSource
  ansible.builtin.apt:
    name:
      - ca-certificates
      - curl
      - gnupg
    state: present
  become: yes

- name: Create directory for apt keyrings
  ansible.builtin.file:
    path: /etc/apt/keyrings
    state: directory
    mode: '0755'
  become: yes

- name: Download NodeSource GPG key
  ansible.builtin.get_url:
    url: https://deb.nodesource.com/gpgkey/nodesource-repo.gpg.key
    dest: /tmp/nodesource.gpg.key
  become: yes

- name: Dearmor NodeSource GPG key
  ansible.builtin.command: gpg --dearmor --yes -o /etc/apt/keyrings/nodesource.gpg /tmp/nodesource.gpg.key
  become: yes

- name: Add NodeSource repository
  ansible.builtin.copy:
    content: "deb [signed-by=/etc/apt/keyrings/nodesource.gpg] https://deb.nodesource.com/node_20.x nodistro main"
    dest: /etc/apt/sources.list.d/nodesource.list
  become: yes

- name: Update apt cache and install Node.js
  ansible.builtin.apt:
    update_cache: yes
    name: nodejs
    state: latest
  become: yes

- name: Clone llxprt-code repository
  ansible.builtin.git:
    repo: 'https://github.com/vybestack/llxprt-code.git'
    dest: "{{ llxprt_code_dir }}"
    version: main

- name: Install llxprt-code dependencies
  ansible.builtin.npm:
    path: "{{ llxprt_code_dir }}"
    state: present

- name: Install llxprt-code globally
  ansible.builtin.npm:
    path: "{{ llxprt_code_dir }}"
    state: present
    global: yes

- name: Discover tool-server-api address
  ansible.builtin.uri:
    url: "http://localhost:{{ consul_http_port }}/v1/health/service/tool-server-api?passing"
    headers:
      X-Consul-Token: "{{ consul_bootstrap_token }}"
    return_content: yes
  register: tool_server_service
  until: tool_server_service.json | length > 0
  retries: 30
  delay: 5

- name: Configure llxprt-code
  ansible.builtin.template:
    src: llxprt-code.env.j2
    dest: "{{ llxprt_code_dir }}/.env"

- name: Remove existing MCP server from llxprt-code
  ansible.builtin.command: llxprt mcp remove tool-server
  ignore_errors: true
  changed_when: true

- name: Add MCP server to llxprt-code
  ansible.builtin.command:
    argv:
      - llxprt
      - mcp
      - add
      - tool-server
      - npx
      - mcp-remote@latest
      - "http://{{ (tool_server_service.json[0].Service.Address) }}:{{ (tool_server_service.json[0].Service.Port) }}/run_tool/"
      - --header
      - "Authorization: Bearer {{ openai_api_key }}"
  changed_when: true
