- name: "Tool Server : Ensure tool_server directories exist"
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: "{{ target_user }}"
    group: "{{ target_user }}"
    mode: "0755"
  loop:
    - "/opt/tool_server"
    - "{{ cluster_infra_dir }}"
    - "{{ mcp_dir }}"
  become: true

- name: "Tool Server : Copy build files"
  ansible.builtin.copy:
    src: "{{ item }}"
    dest: "/opt/tool_server/"
    owner: "{{ target_user }}"
    group: "{{ target_user }}"
    mode: "0644"
  loop:
    - "app.py"
    - "Dockerfile"
    - "preload_models.py"
  become: true

- name: "Tool Server : Copy entrypoint.sh"
  ansible.builtin.copy:
    src: "entrypoint.sh"
    dest: "/opt/tool_server/"
    owner: "{{ target_user }}"
    group: "{{ target_user }}"
    mode: "0755"
  become: true

- name: "Tool Server : Copy pmm_memory.py"
  ansible.builtin.copy:
    src: "{{ role_path }}/../../../pipecatapp/pmm_memory.py"
    dest: "/opt/tool_server/pmm_memory.py"
    owner: "{{ target_user }}"
    group: "{{ target_user }}"
    mode: "0644"
  become: true

- name: "Tool Server : Copy tools directory"
  ansible.builtin.copy:
    src: "{{ role_path }}/../../../pipecatapp/tools"
    dest: "/opt/tool_server/"
    owner: "{{ target_user }}"
    group: "{{ target_user }}"
    mode: "0755"
  become: true

- name: Debug build context
  ansible.builtin.command: "ls -R {{ role_path }}"
  changed_when: false

- name: Build tool-server docker image
  ansible.builtin.command:
    cmd: "docker build --no-cache -t tool-server:local ."
    chdir: "/opt/tool_server"
  become: yes
  register: tool_server_docker_build_result
  changed_when: "'Successfully built' in tool_server_docker_build_result.stdout or 'writing image' in tool_server_docker_build_result.stdout"

- name: Verify tool-server image exists
  ansible.builtin.command: docker image inspect tool-server:local
  become: yes
  changed_when: false

- name: Check if local registry is reachable
  ansible.builtin.wait_for:
    host: "localhost"
    port: 5001
    state: started
    timeout: 1
  register: registry_check
  ignore_errors: true

- name: "Tool Server : Tag and push tool-server image to local registry"
  community.docker.docker_image:
    name: tool-server
    tag: local
    repository: localhost:5001/tool-server
    push: true
    source: local
  become: yes
  when: registry_check is success

- name: "Tool Server : Verify Docker image exists"
  ansible.builtin.command:
    cmd: "docker images -q tool-server:local"
  register: docker_image_check
  failed_when: docker_image_check.stdout | length == 0
  changed_when: false
  become: true

- name: Template tool-server.nomad job file
  ansible.builtin.template:
    src: tool_server.nomad.j2
    dest: "{{ nomad_jobs_dir }}/tool_server.nomad"

- name: "Tool Server : Deploy Tool Server Job"
  block:
    - name: "Tool Server : Purge existing nomad job (force image update)"
      ansible.builtin.command:
        cmd: "/usr/local/bin/nomad job stop -purge tool-server"
      ignore_errors: yes
      changed_when: true
      become: no

    - name: "Tool Server : Run nomad job"
      ansible.builtin.command:
        cmd: "/usr/local/bin/nomad job run {{ nomad_jobs_dir }}/tool_server.nomad"
      changed_when: true
      become: no
      register: tool_server_job_run

  rescue:
    - name: "Tool Server : Get Tool Server job status"
      ansible.builtin.command:
        cmd: /usr/local/bin/nomad job status -verbose tool-server
      register: ts_job_status
      ignore_errors: yes
      become: no

    - name: "Tool Server : Display Tool Server job status"
      ansible.builtin.debug:
        var: ts_job_status.stdout

    - name: "Tool Server : Get Tool Server allocations"
      ansible.builtin.command:
        cmd: /usr/local/bin/nomad job allocs -json tool-server
      register: ts_allocs
      ignore_errors: yes
      become: no

    - name: "Tool Server : Save Tool Server allocations to temp file"
      ansible.builtin.copy:
        content: "{{ ts_allocs.stdout }}"
        dest: "/tmp/ts_allocs.json"

    - name: "Tool Server : Extract Allocation ID"
      ansible.builtin.command: jq -r 'sort_by(.CreateTime) | reverse | .[0].ID' /tmp/ts_allocs.json
      register: ts_alloc_id
      ignore_errors: yes

    - name: "Tool Server : Fetch Tool Server logs (stdout)"
      ansible.builtin.command:
        cmd: "/usr/local/bin/nomad alloc logs {{ ts_alloc_id.stdout }}"
      register: ts_logs_stdout
      ignore_errors: yes
      become: no
      when: ts_alloc_id.stdout | length > 0

    - name: "Tool Server : Display Tool Server logs (stdout)"
      ansible.builtin.debug:
        var: ts_logs_stdout.stdout
      when: ts_logs_stdout is defined

    - name: "Tool Server : Fetch Tool Server logs (stderr)"
      ansible.builtin.command:
        cmd: "/usr/local/bin/nomad alloc logs -stderr {{ ts_alloc_id.stdout }}"
      register: ts_logs_stderr
      ignore_errors: yes
      become: no
      when: ts_alloc_id.stdout | length > 0

    - name: "Tool Server : Display Tool Server logs (stderr)"
      ansible.builtin.debug:
        var: ts_logs_stderr.stdout
      when: ts_logs_stderr is defined

    - name: "Tool Server : Get Allocation Status (Detailed)"
      ansible.builtin.command:
        cmd: "/usr/local/bin/nomad alloc status -verbose {{ ts_alloc_id.stdout }}"
      register: ts_alloc_status
      ignore_errors: yes
      become: no
      when: ts_alloc_id.stdout | length > 0

    - name: "Tool Server : Display Allocation Status"
      ansible.builtin.debug:
        var: ts_alloc_status.stdout
      when: ts_alloc_status is defined

    - name: "Tool Server : Clean up temp file"
      ansible.builtin.file:
        path: "/tmp/ts_allocs.json"
        state: absent

    - name: "Tool Server : Fail after debugging"
      ansible.builtin.fail:
        msg: "Tool Server job failed to start. See logs above."
