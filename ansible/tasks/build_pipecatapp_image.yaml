- name: Copy pipecat startup script to build context
  ansible.builtin.template:
    src: "{{ pipecat_template_src | default(inventory_dir ~ '/ansible/roles/pipecatapp/templates/start_pipecatapp.sh.j2') }}"
    dest: "{{ pipecat_build_dir | default(inventory_dir ~ '/pipecatapp') }}/start_pipecat.sh"
    mode: '0755'
  become: yes
  when: pipecat_deployment_style == 'docker'

- name: Build pipecatapp Docker image when deployment style is docker
  community.docker.docker_image:
    name: "{{ pipecat_image_name | default('pipecatapp') }}"
    tag: "{{ pipecat_image_tag | default('local') }}"
    build:
      path: "{{ pipecat_build_dir | default(inventory_dir ~ '/pipecatapp') }}"
      nocache: true
    source: build
    force_source: true
  register: build_result
  become: yes
  when: pipecat_deployment_style == 'docker'

- name: Check if local registry is reachable
  ansible.builtin.wait_for:
    host: "localhost"
    port: "{{ docker_registry_port }}"
    state: started
    timeout: 1
  register: registry_check
  ignore_errors: true
  when: pipecat_deployment_style == 'docker'

- name: Tag and push pipecatapp image to local registry
  community.docker.docker_image:
    name: "{{ pipecat_image_name | default('pipecatapp') }}"
    tag: "{{ pipecat_image_tag | default('local') }}"
    repository: "localhost:{{ docker_registry_port }}/{{ pipecat_image_name | default('pipecatapp') }}"
    push: true
    source: local
  become: yes
  when: pipecat_deployment_style == 'docker' and registry_check is success
