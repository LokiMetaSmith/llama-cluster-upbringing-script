---
- name: "Set verified model for {{ item }}"
  ansible.builtin.set_fact:
    verified_model: "{{ expert_models[item] | selectattr('filename', 'in', successful_models) | first | default(none) }}"

- name: "Render the GPU Provider Pool job template for {{ item }}"
  ansible.builtin.template:
    src: "{{ playbook_dir }}/ansible/jobs/llamacpp-rpc.nomad.j2"
    dest: "/tmp/llamacpp-rpc-pool-{{ item }}.nomad"
    mode: '0644'
  vars:
    job_name: "llamacpp-rpc-pool-{{ item }}"
    worker_count: "{{ groups['workers'] | length if 'workers' in groups else 1 }}"
    model: "{{ verified_model }}"
  when: verified_model

- name: "Run the GPU Provider Pool job for {{ item }}"
  ansible.builtin.command:
    cmd: "nomad job run /tmp/llamacpp-rpc-pool-{{ item }}.nomad"
  changed_when: true
  when: verified_model
