- name: Set service name facts for {{ model.name }}
  ansible.builtin.set_fact:
    rpc_job_name: "rpc-{{ model.filename | regex_replace('[^a-zA-Z0-9-]', '-') }}"
    rpc_service_name: "rpc-{{ model.filename | regex_replace('[^a-zA-Z0-9-]', '-') }}-provider"

- name: Debug service name for {{ model.name }}
  ansible.builtin.debug:
    msg: "Expecting service: {{ rpc_service_name }} for model {{ model.name }}"

- name: Check for Consul bootstrap token file
  ansible.builtin.stat:
    path: /etc/consul.d/management_token
  register: bootstrap_token_file
  become: yes
  when: consul_bootstrap_token is not defined or consul_bootstrap_token == ''

- name: Read Consul bootstrap token
  ansible.builtin.slurp:
    src: /etc/consul.d/management_token
  register: bootstrap_token_content
  become: yes
  when:
    - consul_bootstrap_token is not defined or consul_bootstrap_token == ''
    - bootstrap_token_file.stat.exists

- name: Set consul_bootstrap_token fact
  ansible.builtin.set_fact:
    consul_bootstrap_token: "{{ bootstrap_token_content.content | b64decode | trim }}"
  when:
    - consul_bootstrap_token is not defined or consul_bootstrap_token == ''
    - bootstrap_token_file.stat.exists
    - bootstrap_token_content.content is defined

- name: "Render the GPU Provider Pool job template for {{ model.name }}"
  ansible.builtin.template:
    src: "{{ playbook_dir }}/../../ansible/jobs/llamacpp-rpc.nomad.j2"
    dest: "/tmp/{{ rpc_job_name }}.nomad"
    mode: '0644'
  vars:
    # We construct the job name to match the service name expected by the expert orchestrator.
    # The template uses: name = "{{ job_name }}-provider".
    # Expert expects: "rpc-<model>-provider".
    # Therefore, we set job_name to "rpc-<model>".
    job_name: "{{ rpc_job_name }}"
    worker_count: "{{ groups['workers'] | length if 'workers' in groups else 1 }}"
    # model variable is passed in implicitly

  when: model is defined

- name: "Run the GPU Provider Pool job for {{ model.name }}"
  ansible.builtin.command:
    cmd: "/usr/local/bin/nomad job run /tmp/{{ rpc_job_name }}.nomad"
  changed_when: true

- name: "Wait for GPU Provider for {{ model.name }} to become healthy in Consul"
  ansible.builtin.uri:
    url: "http://127.0.0.1:{{ consul_http_port }}/v1/health/service/{{ rpc_service_name }}?passing"
    headers:
      X-Consul-Token: "{{ consul_bootstrap_token | default(omit) }}"
    return_content: yes
  register: consul_health
  until: "consul_health.json | length >= expected_worker_count | int"
  retries: 30
  delay: 10
