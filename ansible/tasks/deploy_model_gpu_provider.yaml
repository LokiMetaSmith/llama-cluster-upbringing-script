- name: "Render the GPU Provider Pool job template for {{ model.name }}"
  ansible.builtin.template:
    src: "{{ playbook_dir }}/../../ansible/jobs/llamacpp-rpc.nomad.j2"
    dest: "/tmp/rpc-{{ model.filename | regex_replace('[^a-zA-Z0-9-]', '-') }}.nomad"
    mode: '0644'
  vars:
    # We construct the job name to match the service name expected by the expert orchestrator.
    # The template uses: name = "{{ job_name }}-provider".
    # Expert expects: "rpc-<model>-provider".
    # Therefore, we set job_name to "rpc-<model>".
    job_name: "rpc-{{ model.filename | regex_replace('[^a-zA-Z0-9-]', '-') }}"
    worker_count: "{{ groups['workers'] | length if 'workers' in groups else 1 }}"
    # model variable is passed in implicitly

  when: model is defined

- name: "Run the GPU Provider Pool job for {{ model.name }}"
  ansible.builtin.command:
    cmd: "nomad job run /tmp/rpc-{{ model.filename | regex_replace('[^a-zA-Z0-9-]', '-') }}.nomad"
  changed_when: true

- name: "Wait for GPU Provider for {{ model.name }} to become healthy in Consul"
  ansible.builtin.uri:
    url: "http://127.0.0.1:{{ consul_http_port }}/v1/health/service/rpc-{{ model.filename | regex_replace('[^a-zA-Z0-9-]', '-') }}-provider?passing"
    return_content: yes
  register: consul_health
  until: "consul_health.json | length >= expected_worker_count | int"
  retries: 30
  delay: 10
