# This Nomad job file creates a pool of llama.cpp rpc-server providers.
# Its only purpose is to run the rpc-server daemon on each worker node,
# exposing its GPU(s) to the network for an orchestrator to use.

job "{{ job_name | default('llamacpp-rpc-pool') }}" {
  datacenters = ["dc1"]
  namespace   = "{{ nomad_namespace | default('default') }}"
  
  meta {
    # These should reflect the specific model this job instance is for
    model_name    = "{{ model.name | default('unknown') }}"
    model_filename= "{{ model.filename | default('unknown') }}"
    memory_mb   = "{{ model.memory_mb | default(0) }}"
    # Namespace is defined at job level, redundant here.
    # avg_tps is not available in this loop context.
    # The problematic 'models' line is removed/corrected above.
  }
  
  # --- GPU PROVIDER GROUP ---
  # This group runs the rpc-server processes that expose GPUs.
  group "rpc-provider" {
    count = {{ worker_count | default(1) }}

    scaling {
      enabled = true
      min     = {{ worker_count | default(1) }}
      max     = {{ (worker_count | default(1) | int) * 4 }} # Allow scaling up to 4x the base worker count

      policy {
        cooldown = "1m"
        evaluation_interval = "30s"

        check "cpu_usage" {
          source = "nomad"
          query  = "avg(nomad.client.allocs.cpu.total_percent)"

          strategy "target-value" {
            target = 80
          }
        }
      }
    }

    update {
      max_parallel = 1
      min_healthy_time = "10s"
      healthy_deadline = "3m"
      auto_revert = true
    }

    migrate {
      max_parallel = 1
      health_check = "checks"
      healthy_deadline = "5m"
    }

    reschedule {
      attempts  = 3
      interval  = "5m"
      delay     = "30s"
      unlimited = false
    }

    network {
      mode = "host"
      port "rpc" {} # Nomad will assign a dynamic port.
    }

    # Register the RPC provider in Consul for discovery by the orchestrator.
    service {
      name     = "{{ job_name | default('llamacpp-rpc-pool') }}-provider"
      provider = "consul"
      port     = "rpc"

      # --- METADATA GOES HERE IN TAGS ---
      tags = [
        "rpc-provider", # General tag for discovery
        "model={{ model.filename }}",
        "avg_tps={{ avg_tokens_per_second | default(0) | float | round(2) }}", # Uses var passed from Ansible
        "memory_mb={{ model.memory_mb | default(0) }}"
        # Add other relevant tags if needed
      ]
      # --- END TAGS ---

      check {
        type         = "tcp"
        interval     = "15s"
        timeout      = "5s"
        address_mode = "host"
      }
    }

    task "rpc-server-provider" {
      driver = "raw_exec"

      env {
        NOMAD_PORT_rpc = "${NOMAD_PORT_rpc}"
      }

      config {
        command = "/bin/bash"
        args = [
          "-c",
          "/usr/local/bin/rpc-server -H 0.0.0.0 -p $NOMAD_PORT_rpc"
        ]
      }

      resources {
        cpu    = 500
        memory = 1024 # Memory for the RPC daemon itself.
      }
    }
  }
}
